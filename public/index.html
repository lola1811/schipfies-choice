<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#c45e3a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Schipfie's Choice</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•Ñ</text></svg>">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{--warm:#faf7f2;--cream:#f3ede4;--terra:#c45e3a;--terra-light:#e8856a;--olive:#6b7c52;--olive-light:#8a9e6c;--charcoal:#2d2a26;--stone:#8c857b;--sand:#d4c9b8;--amber:#d4953a;--radius:16px;--radius-sm:10px;--shadow:0 2px 12px rgba(45,42,38,0.08);--shadow-lg:0 8px 32px rgba(45,42,38,0.12)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'DM Sans',sans-serif;background:var(--warm);color:var(--charcoal);min-height:100dvh;-webkit-font-smoothing:antialiased;padding-bottom:70px}

    .header{text-align:center;padding:2rem 1.5rem 1.2rem;position:relative}
    .header::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:60px;height:3px;background:var(--terra);border-radius:2px}
    .logo{font-size:2rem;margin-bottom:0.1rem;display:block}
    .header h1{font-family:'DM Serif Display',serif;font-size:1.5rem;font-weight:400;letter-spacing:-0.01em}
    .header p{color:var(--stone);font-size:0.8rem;margin-top:0.3rem}

    .container{max-width:480px;margin:0 auto;padding:1.5rem}
    .section{margin-bottom:1.5rem}
    .section-label{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--stone);margin-bottom:0.7rem}

    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:white;border-top:1px solid var(--sand);display:flex;z-index:50;padding-bottom:env(safe-area-inset-bottom)}
    .nav-tab{flex:1;padding:0.7rem 0;text-align:center;cursor:pointer;transition:all 0.2s;border:none;background:none;font-family:'DM Sans',sans-serif}
    .nav-tab .nav-icon{font-size:1.3rem;display:block}
    .nav-tab .nav-label{font-size:0.65rem;font-weight:600;color:var(--stone);margin-top:0.15rem}
    .nav-tab.active .nav-label{color:var(--terra)}
    .nav-tab .nav-badge{display:inline-block;background:var(--terra);color:white;font-size:0.55rem;font-weight:700;padding:0.1rem 0.35rem;border-radius:50px;margin-left:0.2rem;vertical-align:top}

    .screen{display:none}.screen.active{display:block}

    .mode-toggle{display:flex;background:var(--cream);border-radius:var(--radius);padding:4px;margin-bottom:1.5rem}
    .mode-btn{flex:1;padding:0.65rem 0.5rem;border:none;border-radius:calc(var(--radius) - 3px);background:transparent;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:500;color:var(--stone);cursor:pointer;transition:all 0.25s ease}
    .mode-btn.active{background:white;color:var(--terra);box-shadow:var(--shadow)}

    .profiles{display:flex;gap:0.7rem}
    .profile-btn{flex:1;padding:0.9rem 0.7rem;border:2px solid var(--sand);border-radius:var(--radius);background:white;cursor:pointer;transition:all 0.2s;text-align:center;position:relative;overflow:hidden}
    .profile-btn::before{content:'';position:absolute;inset:0;background:var(--terra);opacity:0;transition:opacity 0.2s}
    .profile-btn.active{border-color:var(--terra)}.profile-btn.active::before{opacity:0.06}
    .profile-btn .emoji{font-size:1.5rem;display:block;margin-bottom:0.3rem}
    .profile-btn .name{font-weight:600;font-size:0.85rem;position:relative}
    .profile-btn .badge{font-size:0.65rem;color:var(--stone);position:relative;margin-top:0.15rem}
    .profile-btn.active .name{color:var(--terra)}

    .chips{display:flex;flex-wrap:wrap;gap:0.45rem}
    .chip{padding:0.5rem 0.9rem;border:1.5px solid var(--sand);border-radius:50px;background:white;font-size:0.8rem;cursor:pointer;transition:all 0.2s;user-select:none;color:var(--charcoal)}
    .chip:hover{border-color:var(--stone)}.chip.active{background:var(--terra);border-color:var(--terra);color:white}

    .cuisine-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem}
    .cuisine-card{padding:0.8rem 0.4rem;border:1.5px solid var(--sand);border-radius:var(--radius-sm);background:white;text-align:center;cursor:pointer;transition:all 0.2s}
    .cuisine-card:hover{border-color:var(--stone)}
    .cuisine-card.active{border-color:var(--terra);background:linear-gradient(135deg,rgba(196,94,58,0.06),rgba(196,94,58,0.02))}
    .cuisine-card .emoji{font-size:1.4rem;display:block;margin-bottom:0.25rem}
    .cuisine-card .label{font-size:0.72rem;font-weight:500}.cuisine-card.active .label{color:var(--terra)}

    .meal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem}
    .meal-card{padding:0.7rem 0.5rem;border:1.5px solid var(--sand);border-radius:var(--radius-sm);background:white;text-align:center;cursor:pointer;transition:all 0.2s}
    .meal-card:hover{border-color:var(--stone)}
    .meal-card.active{border-color:var(--terra);background:linear-gradient(135deg,rgba(196,94,58,0.06),rgba(196,94,58,0.02))}
    .meal-card .emoji{font-size:1.2rem;display:block;margin-bottom:0.2rem}
    .meal-card .label{font-size:0.72rem;font-weight:500}.meal-card.active .label{color:var(--terra)}

    .generate-btn{width:100%;padding:1rem;background:var(--terra);color:white;border:none;border-radius:var(--radius);font-family:'DM Serif Display',serif;font-size:1.15rem;cursor:pointer;transition:all 0.25s;margin-top:0.5rem}
    .generate-btn:hover{background:var(--terra-light);transform:translateY(-1px);box-shadow:var(--shadow-lg)}
    .generate-btn:active{transform:translateY(0)}
    .generate-btn:disabled{background:var(--sand);cursor:not-allowed;transform:none;box-shadow:none}
    .generate-btn.fav-btn{background:var(--olive)}.generate-btn.fav-btn:hover{background:var(--olive-light)}

    .loading{text-align:center;padding:3rem 1.5rem}
    .loading-spoon{font-size:2.5rem;animation:stir 1.2s ease-in-out infinite;display:inline-block}
    @keyframes stir{0%,100%{transform:rotate(-15deg)}50%{transform:rotate(15deg)}}
    .loading p{color:var(--stone);margin-top:1rem;font-size:0.9rem}
    .loading-dots::after{content:'';animation:dots 1.5s steps(4) infinite}
    @keyframes dots{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}}

    .recipe-card{background:white;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;animation:slideUp 0.4s ease-out}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .recipe-header{background:linear-gradient(135deg,var(--terra) 0%,var(--terra-light) 100%);color:white;padding:1.5rem;position:relative}
    .recipe-header.fav-header{background:linear-gradient(135deg,var(--olive) 0%,var(--olive-light) 100%)}
    .recipe-header h2{font-family:'DM Serif Display',serif;font-size:1.5rem;font-weight:400;line-height:1.25;padding-right:2.5rem}
    .recipe-header .subtitle{opacity:0.85;font-size:0.85rem;margin-top:0.4rem}
    .recipe-meta{display:flex;gap:1rem;margin-top:1rem;font-size:0.78rem;opacity:0.9}
    .recipe-meta span{display:flex;align-items:center;gap:0.3rem}

    .heart-btn{position:absolute;top:1.2rem;right:1.2rem;width:2.5rem;height:2.5rem;border-radius:50%;border:none;background:rgba(255,255,255,0.2);backdrop-filter:blur(4px);cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
    .heart-btn:hover{background:rgba(255,255,255,0.35);transform:scale(1.1)}
    .heart-btn.saved{background:rgba(255,255,255,0.9)}.heart-btn.saving{pointer-events:none;opacity:0.6}
    @keyframes heartPop{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
    .heart-btn.pop{animation:heartPop 0.4s ease}

    .recipe-tags{padding:1rem 1.5rem 0;display:flex;flex-wrap:wrap;gap:0.35rem}
    .recipe-tag{background:var(--cream);padding:0.25rem 0.6rem;border-radius:50px;font-size:0.7rem;color:var(--stone)}
    .recipe-nutrition{display:flex;margin:1rem 1.5rem;background:var(--cream);border-radius:var(--radius-sm);overflow:hidden}
    .nutrition-item{flex:1;text-align:center;padding:0.7rem 0.4rem}
    .nutrition-item:not(:last-child){border-right:1px solid var(--sand)}
    .nutrition-value{font-weight:600;font-size:0.95rem;color:var(--terra)}
    .nutrition-label{font-size:0.65rem;color:var(--stone);margin-top:0.15rem}
    .recipe-section{padding:1rem 1.5rem}
    .recipe-section-title{font-family:'DM Serif Display',serif;font-size:1.05rem;margin-bottom:0.7rem}
    .ingredient-list{list-style:none}
    .ingredient-list li{padding:0.45rem 0;border-bottom:1px solid var(--cream);font-size:0.85rem;display:flex;gap:0.5rem}
    .ingredient-list li:last-child{border:none}
    .ingredient-amount{font-weight:600;color:var(--terra);min-width:70px}
    .steps-list{list-style:none;counter-reset:steps}
    .steps-list li{counter-increment:steps;padding:0.6rem 0 0.6rem 2.2rem;position:relative;font-size:0.85rem;line-height:1.5}
    .steps-list li::before{content:counter(steps);position:absolute;left:0;top:0.55rem;width:1.5rem;height:1.5rem;background:var(--terra);color:white;border-radius:50%;font-size:0.7rem;font-weight:600;display:flex;align-items:center;justify-content:center}

    .recipe-tip,.health-note,.compat-note{margin:0 1.5rem 1rem;padding:0.8rem 1rem;border-radius:0 var(--radius-sm) var(--radius-sm) 0;font-size:0.8rem}
    .recipe-tip{background:linear-gradient(135deg,rgba(107,124,82,0.08),rgba(107,124,82,0.03));border-left:3px solid var(--olive)}
    .recipe-tip strong{color:var(--olive)}
    .health-note{background:linear-gradient(135deg,rgba(212,149,58,0.08),rgba(212,149,58,0.03));border-left:3px solid var(--amber)}
    .health-note strong{color:var(--amber)}
    .compat-note{background:rgba(196,94,58,0.06);border-left:3px solid var(--terra-light);font-size:0.78rem}

    .save-toast{position:fixed;top:1rem;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--charcoal);color:white;padding:0.8rem 1.5rem;border-radius:50px;font-size:0.85rem;font-weight:500;box-shadow:var(--shadow-lg);transition:transform 0.3s ease;z-index:100;white-space:nowrap}
    .save-toast.show{transform:translateX(-50%) translateY(0)}

    .link-btn{display:block;text-align:center;padding:0.7rem;margin:0 1.5rem 1rem;background:var(--cream);color:var(--terra);text-decoration:none;border-radius:var(--radius-sm);font-size:0.82rem;font-weight:600;transition:all 0.2s}
    .link-btn:hover{background:var(--sand)}
    .new-recipe-btn{width:100%;padding:0.9rem;background:white;color:var(--terra);border:2px solid var(--terra);border-radius:var(--radius);font-family:'DM Sans',sans-serif;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.2s;margin-top:1rem}
    .new-recipe-btn:hover{background:var(--terra);color:white}
    .new-recipe-btn.fav{color:var(--olive);border-color:var(--olive)}.new-recipe-btn.fav:hover{background:var(--olive);color:white}
    .back-btn{width:100%;padding:0.7rem;background:transparent;color:var(--stone);border:1.5px solid var(--sand);border-radius:var(--radius);font-family:'DM Sans',sans-serif;font-size:0.85rem;cursor:pointer;transition:all 0.2s;margin-top:0.5rem}
    .back-btn:hover{border-color:var(--stone);color:var(--charcoal)}
    .add-plan-btn{width:100%;padding:0.7rem;background:white;color:var(--amber);border:2px solid var(--amber);border-radius:var(--radius);font-family:'DM Sans',sans-serif;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s;margin-top:0.5rem}
    .add-plan-btn:hover{background:var(--amber);color:white}

    .fav-list{display:flex;flex-direction:column;gap:0.6rem}
    .fav-item{background:white;border-radius:var(--radius-sm);padding:0.9rem 1rem;box-shadow:var(--shadow);cursor:pointer;transition:all 0.2s;border-left:3px solid var(--olive)}
    .fav-item:hover{transform:translateY(-1px);box-shadow:var(--shadow-lg)}
    .fav-item-title{font-weight:600;font-size:0.9rem;margin-bottom:0.2rem}
    .fav-item-subtitle{font-size:0.78rem;color:var(--stone);margin-bottom:0.4rem}
    .fav-item-meta{display:flex;gap:0.5rem;flex-wrap:wrap}
    .fav-item-tag{font-size:0.65rem;background:var(--cream);padding:0.15rem 0.5rem;border-radius:50px;color:var(--stone)}
    .fav-item-note{font-size:0.72rem;color:var(--terra);margin-top:0.35rem;font-style:italic}
    .fav-count{text-align:center;font-size:0.78rem;color:var(--stone);margin-top:0.5rem}
    .inspiration-box{margin-top:1.5rem;padding:1rem;background:white;border-radius:var(--radius);box-shadow:var(--shadow)}
    .inspiration-links{display:flex;flex-direction:column;gap:0.3rem}
    .inspiration-link{color:var(--terra);text-decoration:none;font-size:0.82rem;padding:0.3rem 0}
    .error-card{background:white;border-radius:var(--radius);padding:2rem 1.5rem;text-align:center;box-shadow:var(--shadow)}
    .error-card .emoji{font-size:2rem;margin-bottom:0.7rem}
    .error-card p{color:var(--stone);font-size:0.85rem;margin-bottom:1rem}
    .error-card .error-detail{font-size:0.75rem;color:var(--sand);background:var(--cream);padding:0.5rem;border-radius:var(--radius-sm);margin-bottom:1rem;word-break:break-all}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn 0.2s}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal{background:white;border-radius:var(--radius) var(--radius) 0 0;padding:1.5rem;width:100%;max-width:480px;max-height:70vh;overflow-y:auto;animation:slideModal 0.3s ease}
    @keyframes slideModal{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal h3{font-family:'DM Serif Display',serif;font-size:1.1rem;margin-bottom:1rem}
    .modal-days{display:flex;flex-direction:column;gap:0.5rem}
    .modal-day-btn{padding:0.8rem 1rem;border:1.5px solid var(--sand);border-radius:var(--radius-sm);background:white;text-align:left;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:0.85rem;font-weight:500;transition:all 0.2s;display:flex;justify-content:space-between;align-items:center}
    .modal-day-btn:hover{border-color:var(--terra);background:rgba(196,94,58,0.04)}
    .modal-day-count{font-size:0.72rem;color:var(--stone)}
    .modal-close{width:100%;padding:0.7rem;border:none;background:var(--cream);border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;color:var(--stone);font-size:0.85rem;cursor:pointer;margin-top:0.8rem}

    /* Weekly Plan */
    .plan-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
    .plan-header h2{font-family:'DM Serif Display',serif;font-size:1.3rem;font-weight:400}
    .week-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;background:white;border-radius:var(--radius);padding:0.5rem;box-shadow:var(--shadow)}
    .week-nav-btn{width:2.2rem;height:2.2rem;border-radius:50%;border:1.5px solid var(--sand);background:white;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all 0.2s;font-family:'DM Sans',sans-serif}
    .week-nav-btn:hover{border-color:var(--terra);color:var(--terra)}
    .week-nav-label{font-size:0.85rem;font-weight:600;color:var(--charcoal);text-align:center}
    .week-nav-label .week-type{font-size:0.7rem;font-weight:400;color:var(--stone);display:block;margin-top:0.1rem}
    .week-nav-label.current-week{color:var(--terra)}
    .week-nav-label.current-week .week-type{color:var(--terra);font-weight:600}
    .week-nav-label.other-week{color:var(--stone)}
    .week-nav-label.other-week .week-type{color:var(--sand)}
    .plan-action-btn{padding:0.4rem 0.8rem;border:1.5px solid var(--sand);border-radius:50px;background:white;font-size:0.75rem;cursor:pointer;font-family:'DM Sans',sans-serif;color:var(--stone);transition:all 0.2s}
    .plan-action-btn:hover{border-color:var(--terra);color:var(--terra)}

    .plan-empty{text-align:center;padding:3rem 1.5rem}
    .plan-empty .emoji{font-size:2.5rem;margin-bottom:0.7rem}
    .plan-empty p{color:var(--stone);font-size:0.9rem;margin-bottom:0.3rem}
    .plan-empty .hint{font-size:0.8rem;color:var(--sand)}

    .plan-day{margin-bottom:0.8rem}
    .plan-day-header{padding:0.5rem 0;border-bottom:1px solid var(--sand);margin-bottom:0.4rem;display:flex;justify-content:space-between;align-items:center}
    .plan-day-title{font-family:'DM Serif Display',serif;font-size:0.95rem;color:var(--charcoal)}
    .plan-day-date{font-size:0.72rem;color:var(--stone)}
    .plan-day.today .plan-day-title{color:var(--terra)}

    .plan-recipe{background:white;border-radius:var(--radius-sm);box-shadow:var(--shadow);margin-bottom:0.4rem;overflow:hidden}
    .plan-recipe-header{padding:0.8rem 1rem;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .plan-recipe-info{flex:1}
    .plan-recipe-title{font-weight:600;font-size:0.85rem}
    .plan-recipe-sub{font-size:0.72rem;color:var(--stone);margin-top:0.15rem}
    .plan-recipe-actions{display:flex;gap:0.3rem;align-items:center;flex-shrink:0;margin-left:0.5rem}
    .plan-recipe-toggle{width:1.8rem;height:1.8rem;border-radius:50%;border:none;background:var(--cream);cursor:pointer;font-size:0.7rem;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .plan-recipe-toggle:hover{background:var(--sand)}
    .plan-recipe-toggle.open{transform:rotate(180deg)}
    .plan-recipe-remove{width:1.8rem;height:1.8rem;border-radius:50%;border:none;background:var(--cream);cursor:pointer;font-size:0.75rem;display:flex;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0}
    .plan-recipe-remove:hover{background:var(--terra);color:white}

    .plan-recipe-detail{display:none;padding:0 1rem 1rem;border-top:1px solid var(--cream)}
    .plan-recipe-detail.open{display:block}
    .plan-recipe-detail .ingredient-list{margin-top:0.5rem}
    .plan-recipe-detail .ingredient-list li{font-size:0.8rem;padding:0.3rem 0}
    .plan-recipe-detail .ingredient-amount{min-width:60px;font-size:0.8rem}
    .plan-recipe-detail .steps-list{margin-top:0.5rem}
    .plan-recipe-detail .steps-list li{font-size:0.8rem;padding:0.4rem 0 0.4rem 2rem}
    .plan-recipe-detail .steps-list li::before{width:1.3rem;height:1.3rem;font-size:0.6rem;top:0.4rem}
    .plan-recipe-detail .recipe-tip{margin:0.5rem 0;font-size:0.75rem;padding:0.6rem 0.8rem}
    .plan-recipe-detail .link-btn{margin:0.5rem 0 0;padding:0.5rem;font-size:0.78rem}
    .plan-detail-label{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--stone);margin-top:0.7rem;margin-bottom:0.3rem}

    .plan-day-empty{padding:0.6rem;text-align:center;color:var(--sand);font-size:0.78rem;background:white;border-radius:var(--radius-sm);border:1px dashed var(--sand);cursor:pointer;transition:all 0.2s}
    .plan-day-empty:hover{border-color:var(--terra);color:var(--terra)}
    .plan-other-week .plan-day-header{opacity:0.5}
    .plan-other-week .plan-day-empty{opacity:0.5}
    .plan-summary{text-align:center;padding:1rem;margin-top:0.5rem;font-size:0.8rem;color:var(--stone)}

    /* Favorites Screen */
    .fav-screen-count{font-size:0.78rem;color:var(--stone)}
    .fav-section{margin-bottom:1.5rem}
    .fav-section-header{font-size:0.72rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--stone);margin-bottom:0.5rem;padding-left:0.2rem}
    .fav-cuisine-group{margin-bottom:1.5rem}
    .fav-cuisine-header{font-family:'DM Serif Display',serif;font-size:1.1rem;font-weight:400;color:var(--charcoal);margin-bottom:0.8rem;padding-bottom:0.4rem;border-bottom:1.5px solid var(--sand);display:flex;align-items:center;gap:0.5rem}
    .fav-cuisine-count{font-family:'DM Sans',sans-serif;font-size:0.65rem;background:var(--sand);color:var(--stone);padding:0.1rem 0.4rem;border-radius:50px}
    .fav-saved-item{background:white;border-radius:var(--radius-sm);box-shadow:var(--shadow);margin-bottom:0.4rem;overflow:hidden}
    .fav-saved-header{padding:0.8rem 1rem;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .fav-saved-info{flex:1}
    .fav-saved-title{font-weight:600;font-size:0.85rem}
    .fav-saved-sub{font-size:0.72rem;color:var(--stone);margin-top:0.15rem}
    .fav-saved-date{font-size:0.65rem;color:var(--sand);margin-top:0.1rem}
    .fav-saved-actions{display:flex;gap:0.3rem;align-items:center;flex-shrink:0;margin-left:0.5rem}
    .fav-saved-detail{display:none;padding:0 1rem 1rem;border-top:1px solid var(--cream)}
    .fav-saved-detail.open{display:block}
    .fav-empty{text-align:center;padding:3rem 1.5rem}
    .fav-empty .emoji{font-size:2.5rem;margin-bottom:0.7rem}
    .fav-empty p{color:var(--stone);font-size:0.9rem;margin-bottom:0.3rem}
    .fav-empty .hint{font-size:0.8rem;color:var(--sand)}
    .fav-ki-badge{display:inline-block;background:var(--terra);color:white;font-size:0.6rem;font-weight:700;padding:0.1rem 0.4rem;border-radius:50px;vertical-align:middle;margin-left:0.3rem}
    .fav-cuisine-tag{margin-right:0.3rem}
    .fav-zutaten,.fav-zubereitung{font-size:0.82rem;line-height:1.6;color:var(--charcoal);padding:0.3rem 0}
    .ingredient-input{width:100%;padding:0.75rem 1rem;border:1.5px solid var(--sand);border-radius:var(--radius);background:white;font-family:'DM Sans',sans-serif;font-size:0.85rem;color:var(--charcoal);transition:border-color 0.2s}
    .ingredient-input:focus{outline:none;border-color:var(--terra)}
    .ingredient-input::placeholder{color:var(--sand)}

    .footer{text-align:center;padding:2rem 1.5rem;color:var(--sand);font-size:0.7rem}
    .hidden{display:none !important}
    @media(min-width:520px){.container{padding:2rem}.header{padding:2.5rem 2rem 1.5rem}}
  </style>
</head>
<body>

  <header class="header">
    <span class="logo">ü•Ñ</span>
    <h1>Schipfie's Choice</h1>
    <p>Gesund kochen ‚Äî einfach gemacht</p>
  </header>

  <!-- ‚ïê‚ïê‚ïê SCREEN 1: REZEPTE ‚ïê‚ïê‚ïê -->
  <main class="container screen active" id="screenRecipes">
    <div class="mode-toggle">
      <button class="mode-btn active" onclick="setMode('ai')">‚ú® KI-Rezept</button>
      <button class="mode-btn" onclick="setMode('favorites')">‚ù§Ô∏è Unsere Favoriten</button>
    </div>
    <section class="section">
      <div class="section-label">Wer isst mit?</div>
      <div class="profiles">
        <button class="profile-btn active" data-profile="lucas" onclick="toggleProfile('lucas')"><span class="emoji">üßë‚Äçüç≥</span><div class="name">Luki's Choice</div><div class="badge">Fisch ok ¬∑ Viel Eiwei√ü</div></button>
        <button class="profile-btn active" data-profile="lola" onclick="toggleProfile('lola')"><span class="emoji">üë©‚Äçüç≥</span><div class="name">Lola's Choice</div><div class="badge">Vegetarisch ¬∑ Eisenreich</div></button>
      </div>
    </section>
    <section class="section">
      <div class="section-label">Zus√§tzliche Filter</div>
      <div class="chips">
        <button class="chip" data-filter="glutenfrei" onclick="toggleFilter(this)">Glutenfrei</button>
        <button class="chip" data-filter="laktosefrei" onclick="toggleFilter(this)">Laktosefrei</button>
        <button class="chip" data-filter="vegan" onclick="toggleFilter(this)">Vegan</button>
        <button class="chip" data-filter="salzarm" onclick="toggleFilter(this)">Salzarm</button>
        <button class="chip" data-filter="zuckerfrei" onclick="toggleFilter(this)">Zuckerfrei</button>
        <button class="chip" data-filter="kohlenhydratarm" onclick="toggleFilter(this)">Kohlenhydratarm</button>
      </div>
    </section>
    <section class="section" id="cuisineSection">
      <div class="section-label">K√ºchenstil</div>
      <div class="cuisine-grid">
        <button class="cuisine-card" data-cuisine="asiatisch" onclick="selectCuisine(this)"><span class="emoji">üçú</span><div class="label">Asiatisch</div></button>
        <button class="cuisine-card" data-cuisine="mediterran" onclick="selectCuisine(this)"><span class="emoji">ü´í</span><div class="label">Mediterran</div></button>
        <button class="cuisine-card" data-cuisine="orientalisch" onclick="selectCuisine(this)"><span class="emoji">üßÜ</span><div class="label">Orientalisch</div></button>
        <button class="cuisine-card" data-cuisine="oesterreichisch" onclick="selectCuisine(this)"><span class="emoji">üá¶üáπ</span><div class="label">√ñsterreichisch</div></button>
        <button class="cuisine-card" data-cuisine="comfort" onclick="selectCuisine(this)"><span class="emoji">üç≤</span><div class="label">Comfort</div></button>
        <button class="cuisine-card active" data-cuisine="surprise" onclick="selectCuisine(this)"><span class="emoji">üé≤</span><div class="label">√úberrasch mich</div></button>
      </div>
    </section>
    <section class="section" id="mealTypeSection">
      <div class="section-label">Was soll's sein?</div>
      <div class="meal-grid">
        <button class="meal-card active" data-meal="hauptgericht" onclick="selectMealType(this)"><span class="emoji">üçΩ</span><div class="label">Hauptgericht</div></button>
        <button class="meal-card" data-meal="vorspeise" onclick="selectMealType(this)"><span class="emoji">ü•ó</span><div class="label">Vorspeise / Salat</div></button>
        <button class="meal-card" data-meal="suppe" onclick="selectMealType(this)"><span class="emoji">üç≤</span><div class="label">Suppe</div></button>
        <button class="meal-card" data-meal="snack" onclick="selectMealType(this)"><span class="emoji">ü•ú</span><div class="label">Snack</div></button>
        <button class="meal-card" data-meal="smoothie" onclick="selectMealType(this)"><span class="emoji">ü•§</span><div class="label">Smoothie</div></button>
        <button class="meal-card" data-meal="dessert_gesund" onclick="selectMealType(this)"><span class="emoji">üçì</span><div class="label">Dessert (gesund)</div></button>
        <button class="meal-card" data-meal="dessert_ungesund" onclick="selectMealType(this)"><span class="emoji">üç∞</span><div class="label">Dessert (Genuss)</div></button>
      </div>
    </section>
    <section class="section" id="ingredientSection">
      <div class="section-label">Zutat verkochen? <span style="font-weight:400;text-transform:none;letter-spacing:0">(optional)</span></div>
      <input type="text" id="ingredientInput" class="ingredient-input" placeholder="z.B. Aubergine, Linsen, Lachs‚Ä¶" oninput="state.ingredient=this.value.trim()">
    </section>
    <section class="section"><button class="generate-btn" id="generateBtn" onclick="handleGenerate()">Was kochen wir heute?</button></section>
    <section id="result"></section>
    <footer class="footer">Schipfie's Choice ¬∑ Made with ü§ç in Berlin Mitte</footer>
  </main>

  <!-- ‚ïê‚ïê‚ïê SCREEN 2: WOCHENPLAN ‚ïê‚ïê‚ïê -->
  <div class="container screen" id="screenPlan">
    <div class="plan-header">
      <h2>üìÖ Weekly Plan</h2>
      <button class="plan-action-btn" onclick="clearCurrentWeekPlan()">üóë Leeren</button>
    </div>
    <div class="week-nav">
      <button class="week-nav-btn" onclick="shiftWeek(-1)">‚Üê</button>
      <div class="week-nav-label" id="planWeekLabel"></div>
      <button class="week-nav-btn" onclick="shiftWeek(1)">‚Üí</button>
    </div>
    <div id="planContent"></div>
    <footer class="footer">Schipfie's Choice ¬∑ Made with ü§ç in Berlin Mitte</footer>
  </div>

  <!-- ‚ïê‚ïê‚ïê SCREEN 3: FAVORITES (geherzt) ‚ïê‚ïê‚ïê -->
  <div class="container screen" id="screenFavorites">
    <div class="plan-header">
      <h2>‚ù§Ô∏è Favorites</h2>
      <div class="fav-screen-count" id="favScreenCount"></div>
    </div>
    <div id="favContent"></div>
    <footer class="footer">Schipfie's Choice ¬∑ Made with ü§ç in Berlin Mitte</footer>
  </div>

  <nav class="bottom-nav">
    <button class="nav-tab active" onclick="switchScreen('recipes')"><span class="nav-icon">ü•Ñ</span><span class="nav-label">Rezepte</span></button>
    <button class="nav-tab" onclick="switchScreen('favorites')"><span class="nav-icon">‚ù§Ô∏è</span><span class="nav-label">Favorites<span class="nav-badge" id="favBadge" style="display:none">0</span></span></button>
    <button class="nav-tab" onclick="switchScreen('plan')"><span class="nav-icon">üìÖ</span><span class="nav-label">Weekly Plan<span class="nav-badge" id="planBadge" style="display:none">0</span></span></button>
  </nav>

  <div class="save-toast" id="saveToast"></div>
  <div id="modalContainer"></div>

  <!-- Favorites now loaded from Notion API -->
  <script>
    const state={mode:'ai',profiles:new Set(["lucas","lola"]),filters:{},cuisine:"surprise",mealType:"hauptgericht",currentRecipe:null,screen:'recipes',ingredient:''};
    const DAY_NAMES=['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'];

    // ‚îÄ‚îÄ Screen Navigation ‚îÄ‚îÄ
    function switchScreen(s){
      state.screen=s;
      document.querySelectorAll('.screen').forEach(el=>el.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
      if(s==='recipes'){
        document.getElementById('screenRecipes').classList.add('active');
        document.querySelectorAll('.nav-tab')[0].classList.add('active');
      } else if(s==='favorites'){
        document.getElementById('screenFavorites').classList.add('active');
        document.querySelectorAll('.nav-tab')[1].classList.add('active');
        renderSavedFavorites();
      } else {
        document.getElementById('screenPlan').classList.add('active');
        document.querySelectorAll('.nav-tab')[2].classList.add('active');
        renderPlan();
      }
      window.scrollTo(0,0);
    }

    // ‚îÄ‚îÄ Notion Favorites Cache ‚îÄ‚îÄ
    let notionFavorites = []; // Loaded from Notion API
    let favoritesLoaded = false;

    async function loadFavoritesFromNotion() {
      try {
        const res = await fetch('/api/get-favorites');
        if (!res.ok) throw new Error('API Fehler');
        notionFavorites = await res.json();
        favoritesLoaded = true;
        // Cache locally for offline/fast access
        localStorage.setItem('schipfie-notion-cache', JSON.stringify(notionFavorites));
        updateFavBadge();
        return notionFavorites;
      } catch(e) {
        console.warn('Notion fetch failed, using cache:', e);
        try {
          notionFavorites = JSON.parse(localStorage.getItem('schipfie-notion-cache')) || [];
        } catch(e2) { notionFavorites = []; }
        favoritesLoaded = true;
        updateFavBadge();
        return notionFavorites;
      }
    }

    // Map Notion cuisine names to app cuisine keys
    function mapCuisineFromNotion(name) {
      const map = {'Asiatisch':'asiatisch','Mediterran':'mediterran','Orientalisch':'orientalisch','√ñsterreichisch':'oesterreichisch','Comfort':'comfort','Andere':'other'};
      return map[name] || 'comfort';
    }
    function mapCuisineToNotion(key) {
      const map = {asiatisch:'Asiatisch',mediterran:'Mediterran',orientalisch:'Orientalisch',oesterreichisch:'√ñsterreichisch',comfort:'Comfort',surprise:'Andere'};
      return map[key] || 'Comfort';
    }

    function updateFavBadge(){
      const total = notionFavorites.length;
      const badge = document.getElementById('favBadge');
      if(total>0){badge.style.display='inline-block';badge.textContent=total}else{badge.style.display='none'}
    }

    function toggleFavDetail(id){
      const el=document.getElementById(id);const btn=document.querySelector(`[data-toggle="${id}"]`);
      if(el){el.classList.toggle('open');if(btn)btn.classList.toggle('open')}
    }

    function renderSavedFavorites(){
      const el=document.getElementById('favContent');
      const favCount = notionFavorites.filter(f => f.source === 'Favorit').length;
      const kiCount = notionFavorites.filter(f => f.source === 'KI-generiert').length;
      const manualCount = notionFavorites.length - favCount - kiCount;
      document.getElementById('favScreenCount').textContent = notionFavorites.length ? 
        `${notionFavorites.length} Rezept${notionFavorites.length>1?'e':''} (${favCount} Favoriten${kiCount?' ¬∑ '+kiCount+' KI':''}${manualCount?' ¬∑ '+manualCount+' Manuell':''})` : '';

      if(!favoritesLoaded){
        el.innerHTML='<div class="fav-empty"><div class="emoji">‚è≥</div><p>Lade Favoriten...</p></div>';
        return;
      }
      if(notionFavorites.length===0){
        el.innerHTML=`<div class="fav-empty"><div class="emoji">‚ù§Ô∏è</div><p>Noch keine Favoriten gespeichert</p><p class="hint">Herze Rezepte mit ü§ç um sie hier zu sammeln</p><button class="generate-btn" style="margin-top:1rem;max-width:280px;margin-left:auto;margin-right:auto;display:block" onclick="switchScreen('recipes')">ü•Ñ Rezepte entdecken</button></div>`;
        return;
      }

      const mealOrder=[
        {key:'vorspeise',label:'ü•ó Vorspeise / Salat'},
        {key:'suppe',label:'üç≤ Suppe'},
        {key:'hauptgericht',label:'üçΩ Hauptgericht'},
        {key:'snack',label:'ü•ú Snack'},
        {key:'smoothie',label:'ü•§ Smoothie'},
        {key:'dessert_gesund',label:'üçì Dessert (gesund)'},
        {key:'dessert_ungesund',label:'üç∞ Dessert (Genuss)'},
        {key:'other',label:'ü•Ñ Sonstige'}
      ];

      const grouped={};
      notionFavorites.forEach((f,i)=>{
        const type=f.mealType||'other';
        if(!grouped[type])grouped[type]=[];
        grouped[type].push({...f,origIdx:i});
      });

      let h='';
      mealOrder.forEach(cat=>{
        const items=grouped[cat.key];
        if(!items||items.length===0)return;
        h+=`<div class="fav-section"><div class="fav-section-header">${cat.label}</div>`;
        items.forEach(r=>{h+=renderFavItem(r)});
        h+=`</div>`;
      });
      el.innerHTML=h;
    }

    function renderFavItem(r){
      const detailId=`fav-detail-${r.origIdx}`;
      const hasZutaten = r.zutaten && r.zutaten.trim().length > 0;
      const hasZubereitung = r.zubereitung && r.zubereitung.trim().length > 0;
      const hasDetail = hasZutaten || hasZubereitung || r.link;
      const isKI = r.source === 'KI-generiert';
      const borderColor = isKI ? 'border-left:3px solid var(--terra)' : 'border-left:3px solid var(--olive)';
      const sourceLabel = isKI ? '<span class="fav-ki-badge">‚ú® KI</span>' : '';
      const cuisineEmojis={asiatisch:'üçú',mediterran:'ü´í',orientalisch:'üßÜ',oesterreichisch:'üá¶üáπ',comfort:'üç≤'};
      const cKey = mapCuisineFromNotion(r.cuisine);
      const cuisineTag = cuisineEmojis[cKey] ? `<span class="fav-cuisine-tag">${cuisineEmojis[cKey]}</span>` : '';
      const hearts = (r.geherztVon||[]).map(n => n === 'Lola' ? 'üíú' : 'üíô').join('');

      let h=`<div class="fav-saved-item" style="${borderColor}"><div class="fav-saved-header" ${hasDetail?`onclick="toggleFavDetail('${detailId}')"`:''}><div class="fav-saved-info"><div class="fav-saved-title">${cuisineTag}${r.title} ${sourceLabel}</div>${r.subtitle?`<div class="fav-saved-sub">${r.subtitle}</div>`:''}${r.prepTime?`<div class="fav-saved-sub">‚è± ${r.prepTime} Min ${hearts?'¬∑ '+hearts:''}</div>`:`${hearts?`<div class="fav-saved-sub">${hearts}</div>`:''}`}</div><div class="fav-saved-actions">${hasDetail?`<button class="plan-recipe-toggle" data-toggle="${detailId}" onclick="event.stopPropagation();toggleFavDetail('${detailId}')">‚ñº</button>`:''}</div></div>`;
      if(hasDetail){
        h+=`<div class="fav-saved-detail" id="${detailId}">`;
        if(hasZutaten){
          h+=`<div class="plan-detail-label">Zutaten</div><div class="fav-zutaten">${r.zutaten.replace(/\n/g,'<br>')}</div>`;
        }
        if(hasZubereitung){
          h+=`<div class="plan-detail-label">Zubereitung</div><div class="fav-zubereitung">${r.zubereitung.replace(/\n/g,'<br>')}</div>`;
        }
        if(r.tipps)h+=`<div class="recipe-tip"><strong>üí°</strong> ${r.tipps}</div>`;
        if(r.healthNote)h+=`<div class="health-note"><strong>üåø</strong> ${r.healthNote}</div>`;
        if(r.link)h+=`<a class="link-btn" href="${r.link}" target="_blank" onclick="event.stopPropagation()">üìñ Originalrezept</a>`;
        h+=`</div>`;
      }
      h+=`</div>`;
      return h;
    }

    // ‚îÄ‚îÄ Week Calculation ‚îÄ‚îÄ
    let weekOffset=0; // 0=current, -1=last, +1=next

    function getMondayOfWeek(offset){
      const now=new Date();const day=now.getDay();
      const diffToMonday=(day===0?-6:1-day);
      const mon=new Date(now);mon.setDate(now.getDate()+diffToMonday+(offset*7));mon.setHours(0,0,0,0);
      return mon;
    }
    function getWeekDates(offset){
      const mon=getMondayOfWeek(offset||0);
      return DAY_NAMES.map((name,i)=>{
        const d=new Date(mon);d.setDate(mon.getDate()+i);
        return{name,date:d,dateStr:d.toLocaleDateString('de-DE',{day:'numeric',month:'short'}),key:d.toISOString().split('T')[0]};
      });
    }
    function getWeekKey(offset){return getMondayOfWeek(offset||0).toISOString().split('T')[0]}
    function isToday(dateKey){return new Date().toISOString().split('T')[0]===dateKey}
    function shiftWeek(dir){weekOffset=Math.max(-1,Math.min(1,weekOffset+dir));renderPlan()}

    // ‚îÄ‚îÄ Plan Storage (per week) ‚îÄ‚îÄ
    function getAllPlans(){try{return JSON.parse(localStorage.getItem('schipfie-plans'))||{}}catch(e){return{}}}
    function saveAllPlans(plans){localStorage.setItem('schipfie-plans',JSON.stringify(plans));updateBadge()}
    function getPlanDays(offset){
      const plans=getAllPlans();const key=getWeekKey(offset||0);
      return plans[key]||{};
    }
    function savePlanDays(days,offset){
      const plans=getAllPlans();const key=getWeekKey(offset||0);
      plans[key]=days;
      // Auto-cleanup: remove plans older than 2 weeks
      const twoWeeksAgo=getMondayOfWeek(-2).toISOString().split('T')[0];
      Object.keys(plans).forEach(k=>{if(k<twoWeeksAgo)delete plans[k]});
      saveAllPlans(plans);
    }
    function updateBadge(){
      const currentDays=getPlanDays(0);
      const total=Object.values(currentDays).reduce((s,d)=>s+d.length,0);
      const badge=document.getElementById('planBadge');
      if(total>0){badge.style.display='inline-block';badge.textContent=total}else{badge.style.display='none'}
    }

    function addRecipeToPlan(recipe,dayKey,offset){
      const days=getPlanDays(offset||0);
      if(!days[dayKey])days[dayKey]=[];
      days[dayKey].push({
        title:recipe.title||'Rezept',subtitle:recipe.subtitle||'',prepTime:recipe.prepTime||'',
        link:recipe.link||null,ingredients:recipe.ingredients||[],steps:recipe.steps||[],
        tips:recipe.tips||'',id:recipe.id||('ai-'+Date.now()),source:recipe.source||'KI-generiert'
      });
      savePlanDays(days,offset||0);
      document.getElementById('modalContainer').innerHTML='';
      const week=getWeekDates(offset||0);
      const dayName=week.find(d=>d.key===dayKey)?.name||dayKey;
      showToast(`‚úÖ "${recipe.title}" ‚Üí ${dayName}`);
    }

    function removePlanRecipe(dayKey,idx){
      const days=getPlanDays(weekOffset);
      if(days[dayKey]){days[dayKey].splice(idx,1);if(days[dayKey].length===0)delete days[dayKey]}
      savePlanDays(days,weekOffset);renderPlan();
    }

    function clearCurrentWeekPlan(){if(!confirm('Wochenplan f√ºr diese Woche wirklich leeren?'))return;savePlanDays({},weekOffset);renderPlan()}

    function togglePlanDetail(id){
      const el=document.getElementById(id);const btn=document.querySelector(`[data-toggle="${id}"]`);
      if(el){el.classList.toggle('open');if(btn)btn.classList.toggle('open')}
    }

    function showDayPicker(){
      const recipe=state.currentRecipe;if(!recipe){showToast('‚ùå Kein Rezept ausgew√§hlt');return}
      // Show current week + next week
      const weeks=[
        {offset:0,label:'Diese Woche'},
        {offset:1,label:'N√§chste Woche'}
      ];
      let h=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal"><h3>üìÖ Zu welchem Tag hinzuf√ºgen?</h3><div class="modal-days">`;
      weeks.forEach(w=>{
        const week=getWeekDates(w.offset);const days=getPlanDays(w.offset);
        h+=`<div style="font-size:0.72rem;font-weight:600;color:var(--stone);text-transform:uppercase;letter-spacing:0.08em;margin:0.6rem 0 0.3rem">${w.label}</div>`;
        week.forEach(d=>{
          const count=(days[d.key]||[]).length;
          h+=`<button class="modal-day-btn" onclick="addRecipeToPlan(state.currentRecipe,'${d.key}',${w.offset})"><span>${d.name}, ${d.dateStr}</span><span class="modal-day-count">${count?count+' Rezept'+(count>1?'e':''):'leer'}</span></button>`;
        });
      });
      h+=`</div><button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Abbrechen</button></div></div>`;
      document.getElementById('modalContainer').innerHTML=h;
    }

    function renderPlan(){
      const week=getWeekDates(weekOffset);const days=getPlanDays(weekOffset);const el=document.getElementById('planContent');
      const total=Object.values(days).reduce((s,d)=>s+d.length,0);

      // Week label with type
      const weekType=weekOffset===-1?'Letzte Woche':weekOffset===0?'Diese Woche':'N√§chste Woche';
      const labelEl=document.getElementById('planWeekLabel');
      labelEl.innerHTML=`${week[0].dateStr} ‚Äì ${week[6].dateStr}<span class="week-type">${weekType}</span>`;
      labelEl.className='week-nav-label '+(weekOffset===0?'current-week':'other-week');

      const isOtherWeek=weekOffset!==0;

      // Always show all 7 days
      let h='';
      week.forEach(d=>{
        const recipes=days[d.key]||[];
        const todayClass=isToday(d.key)?' today':'';
        const otherClass=isOtherWeek?' plan-other-week':'';
        h+=`<div class="plan-day${todayClass}${otherClass}"><div class="plan-day-header"><div class="plan-day-title">${d.name}</div><div class="plan-day-date">${d.dateStr}</div></div>`;
        if(recipes.length===0){
          h+=`<div class="plan-day-empty" onclick="switchScreen('recipes')">+ Rezept finden</div>`;
        } else {
          recipes.forEach((r,ri)=>{
            const detailId=`detail-${d.key}-${ri}`;
            const hasDetail=(r.ingredients&&r.ingredients.length>0)||(r.steps&&r.steps.length>0)||r.link;
            const isKI=r.source==='KI-generiert';
            const borderStyle=isKI?'border-left:3px solid var(--terra)':'border-left:3px solid var(--olive)';
            const kiBadge=isKI?'<span class="fav-ki-badge">‚ú® KI</span>':'';
            h+=`<div class="plan-recipe" style="${borderStyle}"><div class="plan-recipe-header" ${hasDetail?`onclick="togglePlanDetail('${detailId}')"`:''}><div class="plan-recipe-info"><div class="plan-recipe-title">${r.title} ${kiBadge}</div>${r.prepTime?`<div class="plan-recipe-sub">‚è± ${r.prepTime} Min</div>`:''}</div><div class="plan-recipe-actions">${hasDetail?`<button class="plan-recipe-toggle" data-toggle="${detailId}" onclick="event.stopPropagation();togglePlanDetail('${detailId}')">‚ñº</button>`:''}<button class="plan-recipe-remove" onclick="event.stopPropagation();removePlanRecipe('${d.key}',${ri})" title="Entfernen">‚úï</button></div></div>`;
            if(hasDetail){
              h+=`<div class="plan-recipe-detail" id="${detailId}">`;
              if(r.ingredients&&r.ingredients.length>0){
                h+=`<div class="plan-detail-label">Zutaten</div><ul class="ingredient-list">`;
                r.ingredients.forEach(ing=>{h+=`<li><span class="ingredient-amount">${ing.amount} ${ing.unit||''}</span><span>${ing.name}</span></li>`});
                h+=`</ul>`;
              }
              if(r.steps&&r.steps.length>0){
                h+=`<div class="plan-detail-label">Zubereitung</div><ol class="steps-list">`;
                r.steps.forEach(s=>{h+=`<li>${s}</li>`});
                h+=`</ol>`;
              }
              if(r.tips)h+=`<div class="recipe-tip"><strong>üí°</strong> ${r.tips}</div>`;
              if(r.link)h+=`<a class="link-btn" href="${r.link}" target="_blank" onclick="event.stopPropagation()">üìñ Originalrezept</a>`;
              h+=`</div>`;
            }
            h+=`</div>`;
          });
        }
        h+=`</div>`;
      });
      if(total>0)h+=`<div class="plan-summary">${total} Rezept${total>1?'e':''} ${weekType.toLowerCase()}</div>`;
      el.innerHTML=h;
    }

    // ‚îÄ‚îÄ Recipe Screen Logic ‚îÄ‚îÄ
    function setMode(m){
      state.mode=m;document.querySelectorAll('.mode-btn').forEach((b,i)=>b.classList.toggle('active',(i===0&&m==='ai')||(i===1&&m==='favorites')));
      document.getElementById('ingredientSection').classList.toggle('hidden',m==='favorites');
      const btn=document.getElementById('generateBtn');
      if(m==='ai'){btn.textContent='Was kochen wir heute?';btn.classList.remove('fav-btn')}else{btn.textContent='‚ù§Ô∏è Zeig mir einen Favoriten!';btn.classList.add('fav-btn')}
      document.getElementById('result').innerHTML='';
    }
    function toggleProfile(n){if(state.profiles.has(n)){if(state.profiles.size>1)state.profiles.delete(n)}else state.profiles.add(n);document.querySelectorAll('.profile-btn').forEach(b=>b.classList.toggle('active',state.profiles.has(b.dataset.profile)))}
    function toggleFilter(el){el.classList.toggle('active');state.filters[el.dataset.filter]=el.classList.contains('active')}
    function selectCuisine(el){document.querySelectorAll('.cuisine-card').forEach(c=>c.classList.remove('active'));el.classList.add('active');state.cuisine=el.dataset.cuisine}
    function selectMealType(el){document.querySelectorAll('.meal-card').forEach(c=>c.classList.remove('active'));el.classList.add('active');state.mealType=el.dataset.meal}
    function handleGenerate(){state.mode==='ai'?generateRecipe():showRandomFavorite()}
    function getCompatibleFavorites(){
      const lucasOnly=state.profiles.has('lucas')&&!state.profiles.has('lola');
      return notionFavorites.filter(f=>{
        if(lucasOnly){
          const pf=f.passtFuer||[];
          if(!pf.includes('Luki')&&!pf.includes('Beide'))return false;
        }
        if(f.mealType&&f.mealType!==state.mealType)return false;
        if(state.cuisine!=='surprise'){
          const fCuisine=mapCuisineFromNotion(f.cuisine);
          if(fCuisine&&fCuisine!==state.cuisine)return false;
        }
        return true;
      });
    }

    function showRandomFavorite(){
      const c=getCompatibleFavorites();
      if(!c.length){document.getElementById('result').innerHTML='<div class="error-card"><div class="emoji">ü§∑</div><p>Noch keine Favoriten in dieser Kategorie.</p><button class="new-recipe-btn" onclick="setMode(\'ai\');handleGenerate()">‚ú® KI-Rezept generieren</button></div>';return}
      renderFavorite(c[Math.floor(Math.random()*c.length)]);
    }
    function showAllFavorites(){
      const c=getCompatibleFavorites();const result=document.getElementById('result');
      const cuisineEmojis={asiatisch:'üçú',mediterran:'ü´í',orientalisch:'üßÜ',oesterreichisch:'üá¶üáπ',comfort:'üç≤'};
      let h='<div class="fav-list">';
      c.forEach(f=>{
        const tags=(f.tags||[]).map(t=>`<span class="fav-item-tag">${t}</span>`).join('');
        const cKey=mapCuisineFromNotion(f.cuisine);
        const cEmoji=cuisineEmojis[cKey]||'';
        h+=`<div class="fav-item" onclick="renderFavoriteById('${f.id}')"><div class="fav-item-title">${cEmoji} ${f.title}</div><div class="fav-item-subtitle">${f.subtitle||''}</div><div class="fav-item-meta">${tags}</div></div>`;
      });
      h+=`</div><div class="fav-count">${c.length} Rezepte</div>`;
      result.innerHTML=h;result.scrollIntoView({behavior:'smooth',block:'start'});
    }
    function renderFavoriteById(id){renderFavorite(notionFavorites.find(r=>r.id===id))}

    function renderFavorite(r){
      if(!r)return;
      state.currentRecipe={...r,source:r.source||'Favorit',profiles:Array.from(state.profiles)};
      const result=document.getElementById('result');
      const hasZutaten=r.zutaten&&r.zutaten.trim().length>0;
      const hasZubereitung=r.zubereitung&&r.zubereitung.trim().length>0;
      const both=state.profiles.has('lucas')&&state.profiles.has('lola');
      const tags=(r.tags||[]).map(t=>`<span class="recipe-tag">${t}</span>`).join('');
      let h=`<div class="recipe-card"><div class="recipe-header fav-header"><h2>${r.title}</h2><button class="heart-btn" onclick="saveToNotion(this)" title="In Notion speichern">ü§ç</button>${r.subtitle?`<div class="subtitle">${r.subtitle}</div>`:''}<div class="recipe-meta">${r.prepTime?`<span>‚è± ${r.prepTime} Min</span>`:''}${r.servings?`<span>üçΩ ${r.servings} Portionen</span>`:''}<span>‚ù§Ô∏è Favorit</span></div></div>`;
      if(tags)h+=`<div class="recipe-tags">${tags}</div>`;
      if(r.tipps&&r.tipps.includes('üßÄ')&&both)h+=`<div class="compat-note">${r.tipps}</div>`;
      if(hasZutaten){h+=`<div class="recipe-section"><div class="recipe-section-title">Zutaten</div><div class="fav-zutaten">${r.zutaten.replace(/\n/g,'<br>')}</div></div>`}
      if(hasZubereitung){h+=`<div class="recipe-section"><div class="recipe-section-title">Zubereitung</div><div class="fav-zubereitung">${r.zubereitung.replace(/\n/g,'<br>')}</div></div>`}
      if(!hasZutaten&&!hasZubereitung){h+=`<div class="recipe-section" style="text-align:center;padding:1.5rem"><p style="color:var(--stone);font-size:0.85rem">Schnellansicht ‚Äî Originalrezept f√ºr Details √∂ffnen</p></div>`}
      if(r.tipps&&!r.tipps.includes('üßÄ'))h+=`<div class="recipe-tip"><strong>üí° Tipp:</strong> ${r.tipps}</div>`;
      if(r.link)h+=`<a class="link-btn" href="${r.link}" target="_blank">üìñ Originalrezept √∂ffnen</a>`;
      h+=`</div><button class="add-plan-btn" onclick="showDayPicker()">üìÖ Zum Wochenplan hinzuf√ºgen</button><button class="new-recipe-btn fav" onclick="showRandomFavorite()">üîÑ Anderer Favorit</button><button class="back-btn" onclick="showAllFavorites()">üìã Alle Favoriten anzeigen</button>`;
      result.innerHTML=h;result.scrollIntoView({behavior:'smooth',block:'start'});
    }

    async function saveToNotion(btn){
      if(btn.classList.contains('saved')||btn.classList.contains('saving'))return;btn.classList.add('saving');btn.textContent='‚è≥';
      const recipe=state.currentRecipe;if(!recipe){showToast('‚ùå Kein Rezept zum Speichern');btn.classList.remove('saving');btn.textContent='ü§ç';return}
      // Save locally first
      addSavedFav(recipe);
      try{const res=await fetch('/api/save-to-notion',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(recipe)});if(!res.ok)throw new Error((await res.json().catch(()=>({}))).error||'Fehler');btn.classList.remove('saving');btn.classList.add('saved','pop');btn.textContent='‚ù§Ô∏è';btn.style.pointerEvents='none';showToast('‚úÖ Gespeichert!')}
      catch(e){btn.classList.remove('saving');btn.classList.add('saved','pop');btn.textContent='‚ù§Ô∏è';btn.style.pointerEvents='none';showToast('‚ù§Ô∏è Lokal gespeichert (Notion-Sync fehlgeschlagen)')}
    }
    function showToast(msg){const t=document.getElementById('saveToast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}

    async function generateRecipe(){
      const btn=document.getElementById('generateBtn');const result=document.getElementById('result');
      btn.disabled=true;btn.textContent='Wird gekocht‚Ä¶';
      result.innerHTML=`<div class="loading"><span class="loading-spoon">ü•Ñ</span><p>Claude kocht etwas Feines<span class="loading-dots"></span></p></div>`;
      try{const res=await fetch('/api/generate-recipe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({profiles:Array.from(state.profiles),filters:state.filters,cuisine:state.cuisine,mealType:state.mealType,maxMinutes:30,ingredient:state.ingredient||null})});if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(e.details||e.error||`HTTP ${res.status}`)}const recipe=await res.json();recipe.source='KI-generiert';recipe.profiles=Array.from(state.profiles);recipe.cuisine=state.cuisine;recipe.mealType=state.mealType;state.currentRecipe=recipe;renderAIRecipe(recipe)}
      catch(error){result.innerHTML=`<div class="error-card"><div class="emoji">üò¢</div><p>Da ist leider etwas schiefgegangen.</p><div class="error-detail">${error.message}</div><button class="new-recipe-btn" onclick="generateRecipe()">Nochmal versuchen</button></div>`}
      finally{btn.disabled=false;btn.textContent='Was kochen wir heute?'}
    }

    function renderAIRecipe(r){
      const result=document.getElementById('result');
      const tags=(r.tags||[]).map(t=>`<span class="recipe-tag">${t}</span>`).join('');
      const ingr=(r.ingredients||[]).map(i=>`<li><span class="ingredient-amount">${i.amount} ${i.unit||''}</span><span>${i.name}</span></li>`).join('');
      const steps=(r.steps||[]).map(s=>`<li>${s}</li>`).join('');
      result.innerHTML=`
        <div class="recipe-card"><div class="recipe-header"><h2>${r.title||'Rezept'}</h2><button class="heart-btn" onclick="saveToNotion(this)" title="In Notion speichern">ü§ç</button>${r.subtitle?`<div class="subtitle">${r.subtitle}</div>`:''}<div class="recipe-meta"><span>‚è± ${r.prepTime||'30'} Min</span><span>üçΩ ${r.servings||'2'} Portionen</span></div></div>
          ${tags?`<div class="recipe-tags">${tags}</div>`:''}
          ${r.nutrition?`<div class="recipe-nutrition"><div class="nutrition-item"><div class="nutrition-value">${r.nutrition.calories||'‚Äì'}</div><div class="nutrition-label">kcal</div></div><div class="nutrition-item"><div class="nutrition-value">${r.nutrition.protein||'‚Äì'}</div><div class="nutrition-label">Eiwei√ü</div></div><div class="nutrition-item"><div class="nutrition-value">${r.nutrition.fiber||'‚Äì'}</div><div class="nutrition-label">Ballaststoffe</div></div></div>`:''}
          <div class="recipe-section"><div class="recipe-section-title">Zutaten</div><ul class="ingredient-list">${ingr}</ul></div>
          <div class="recipe-section"><div class="recipe-section-title">Zubereitung</div><ol class="steps-list">${steps}</ol></div>
          ${r.tips?`<div class="recipe-tip"><strong>üí° Tipp:</strong> ${r.tips}</div>`:''}
          ${r.healthNote?`<div class="health-note"><strong>üåø Gesundheitshinweis:</strong> ${r.healthNote}</div>`:''}
        </div>
        <button class="add-plan-btn" onclick="showDayPicker()">üìÖ Zum Wochenplan hinzuf√ºgen</button>
        <button class="new-recipe-btn" onclick="generateRecipe()">üîÑ Neues Rezept</button>`;
      result.scrollIntoView({behavior:'smooth',block:'start'});
    }

    // Init
    // Load cached favorites immediately for fast UI
    try { notionFavorites = JSON.parse(localStorage.getItem('schipfie-notion-cache')) || []; } catch(e) {}
    updateFavBadge();
    // Then refresh from Notion in background
    loadFavoritesFromNotion().then(() => {
      updateFavBadge();
      if(document.getElementById('screenFavorites').classList.contains('active')) renderSavedFavorites();
    });
    if('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
  </script>
</body>
</html>