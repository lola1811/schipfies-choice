<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#c45e3a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Schipfie's Choice</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•Ñ</text></svg>">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{--warm:#faf7f2;--cream:#f3ede4;--terra:#c45e3a;--terra-light:#e8856a;--olive:#6b7c52;--olive-light:#8a9e6c;--charcoal:#2d2a26;--stone:#8c857b;--sand:#d4c9b8;--amber:#d4953a;--radius:16px;--radius-sm:10px;--shadow:0 2px 12px rgba(45,42,38,0.08);--shadow-lg:0 8px 32px rgba(45,42,38,0.12)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'DM Sans',sans-serif;background:var(--warm);color:var(--charcoal);min-height:100dvh;-webkit-font-smoothing:antialiased;padding-top:env(safe-area-inset-top);padding-bottom:70px}

    .header{text-align:center;padding:2rem 1.5rem 1.2rem;position:relative}
    .header::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:60px;height:3px;background:var(--terra);border-radius:2px}
    .logo{font-size:2rem;margin-bottom:0.1rem;display:block}
    .header h1{font-family:'DM Serif Display',serif;font-size:1.5rem;font-weight:400;letter-spacing:-0.01em}
    .header p{color:var(--stone);font-size:0.8rem;margin-top:0.3rem}

    .container{max-width:480px;margin:0 auto;padding:1.5rem}
    .section{margin-bottom:1.5rem}
    .section-label{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.1em;color:var(--stone);margin-bottom:0.7rem}

    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:white;border-top:1px solid var(--sand);display:flex;z-index:50;padding-bottom:env(safe-area-inset-bottom);padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right)}
    .nav-tab{flex:1;padding:0.7rem 0;text-align:center;cursor:pointer;transition:all 0.2s;border:none;background:none;font-family:'DM Sans',sans-serif;position:relative}
    .nav-tab .nav-icon{font-size:1.3rem;display:block}
    .nav-tab .nav-label{font-size:0.65rem;font-weight:500;color:var(--stone);margin-top:0.15rem}
    .nav-tab.active .nav-label{color:var(--terra);font-weight:600}
    .nav-tab.active::after{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:20px;height:2.5px;background:var(--terra);border-radius:2px}
    .nav-tab .nav-badge{display:inline-block;background:var(--terra);color:white;font-size:0.55rem;font-weight:700;padding:0.1rem 0.35rem;border-radius:50px;margin-left:0.2rem;vertical-align:top}
    .mode-ai .mode-toggle{background:linear-gradient(135deg,rgba(196,94,58,0.15),rgba(212,149,58,0.12))}
    .mode-fav .mode-toggle{background:linear-gradient(135deg,rgba(107,124,82,0.15),rgba(138,158,108,0.12))}
    #screenRecipes.mode-ai .generate-btn{background:linear-gradient(135deg,var(--terra),var(--amber)) !important}
    #screenRecipes.mode-fav .generate-btn{background:linear-gradient(135deg,var(--olive),var(--olive-light)) !important}
    #screenRecipes.mode-ai .section-label{color:var(--terra)}
    #screenRecipes.mode-fav .section-label{color:var(--olive)}
    #screenRecipes.mode-ai .header::after{background:var(--terra)}
    #screenRecipes.mode-fav .header::after{background:var(--olive)}

    .screen{display:none}.screen.active{display:block}

    .mode-toggle{display:flex;background:var(--cream);border-radius:var(--radius);padding:4px;margin-bottom:1.5rem}
    .mode-btn{flex:1;padding:0.65rem 0.5rem;border:none;border-radius:calc(var(--radius) - 3px);background:transparent;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:500;color:var(--stone);cursor:pointer;transition:all 0.25s ease}
    .mode-btn.active{background:white;color:var(--terra);box-shadow:var(--shadow)}

    .profiles{display:flex;gap:0.7rem}
    .profile-btn{flex:1;padding:0.9rem 0.7rem;border:2px solid var(--sand);border-radius:var(--radius);background:white;cursor:pointer;transition:all 0.2s;text-align:center;position:relative;overflow:hidden}
    .profile-btn::before{content:'';position:absolute;inset:0;background:var(--terra);opacity:0;transition:opacity 0.2s}
    .profile-btn.active{border-color:var(--terra)}.profile-btn.active::before{opacity:0.06}
    .profile-btn .emoji{font-size:1.5rem;display:block;margin-bottom:0.3rem}
    .profile-btn .name{font-weight:600;font-size:0.85rem;position:relative}
    .profile-btn .badge{font-size:0.65rem;color:var(--stone);position:relative;margin-top:0.15rem}
    .profile-btn.active .name{color:var(--terra)}

    .chips{display:flex;flex-wrap:wrap;gap:0.45rem}
    .chip{padding:0.5rem 0.9rem;border:1.5px solid var(--sand);border-radius:50px;background:white;font-size:0.8rem;cursor:pointer;transition:all 0.2s;user-select:none;color:var(--charcoal)}
    .chip:hover{border-color:var(--stone)}.chip.active{background:var(--terra);border-color:var(--terra);color:white}

    .cuisine-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem}
    .cuisine-card{padding:0.8rem 0.4rem;border:1.5px solid var(--sand);border-radius:var(--radius-sm);background:white;text-align:center;cursor:pointer;transition:all 0.2s}
    .cuisine-card:hover{border-color:var(--stone)}
    .cuisine-card.active{border-color:var(--terra);background:linear-gradient(135deg,rgba(196,94,58,0.06),rgba(196,94,58,0.02))}
    .cuisine-card .emoji{font-size:1.4rem;display:block;margin-bottom:0.25rem}
    .cuisine-card .label{font-size:0.72rem;font-weight:500}.cuisine-card.active .label{color:var(--terra)}

    .meal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.5rem}
    .meal-card{padding:0.7rem 0.5rem;border:1.5px solid var(--sand);border-radius:var(--radius-sm);background:white;text-align:center;cursor:pointer;transition:all 0.2s}
    .meal-card:hover{border-color:var(--stone)}
    .meal-card.active{border-color:var(--terra);background:linear-gradient(135deg,rgba(196,94,58,0.06),rgba(196,94,58,0.02))}
    .meal-card .emoji{font-size:1.2rem;display:block;margin-bottom:0.2rem}
    .meal-card .label{font-size:0.72rem;font-weight:500}.meal-card.active .label{color:var(--terra)}

    .generate-btn{width:100%;padding:1rem;background:var(--terra);color:white;border:none;border-radius:var(--radius);font-family:'DM Serif Display',serif;font-size:1.15rem;cursor:pointer;transition:all 0.25s;margin-top:0.5rem}
    .generate-btn:hover{background:var(--terra-light);transform:translateY(-1px);box-shadow:var(--shadow-lg)}
    .generate-btn:active{transform:translateY(0)}
    .generate-btn:disabled{background:var(--sand);cursor:not-allowed;transform:none;box-shadow:none}
    .generate-btn.fav-btn{background:var(--olive)}.generate-btn.fav-btn:hover{background:var(--olive-light)}

    /* ‚îÄ‚îÄ Favoriten-Modus: alle aktiven Elemente olive/gr√ºn ‚îÄ‚îÄ */
    #screenRecipes.mode-fav .profile-btn.active{border-color:var(--olive)}
    #screenRecipes.mode-fav .profile-btn.active::before{background:var(--olive)}
    #screenRecipes.mode-fav .profile-btn.active .name{color:var(--olive)}
    #screenRecipes.mode-fav .chip.active{background:var(--olive);border-color:var(--olive)}
    #screenRecipes.mode-fav .cuisine-card.active{border-color:var(--olive);background:linear-gradient(135deg,rgba(107,124,82,0.08),rgba(107,124,82,0.02))}
    #screenRecipes.mode-fav .cuisine-card.active .label{color:var(--olive)}
    #screenRecipes.mode-fav .meal-card.active{border-color:var(--olive);background:linear-gradient(135deg,rgba(107,124,82,0.08),rgba(107,124,82,0.02))}
    #screenRecipes.mode-fav .meal-card.active .label{color:var(--olive)}
    #screenRecipes.mode-fav .section-label{color:var(--olive)}
    #screenRecipes.mode-fav .mode-btn.active{color:var(--olive)}
    #screenRecipes.mode-fav .ingredient-input:focus{border-color:var(--olive)}

    .loading{text-align:center;padding:3rem 1.5rem}
    .loading-spoon{font-size:2.5rem;animation:stir 1.2s ease-in-out infinite;display:inline-block}
    @keyframes stir{0%,100%{transform:rotate(-15deg)}50%{transform:rotate(15deg)}}
    .loading p{color:var(--stone);margin-top:1rem;font-size:0.9rem}
    .loading-dots::after{content:'';animation:dots 1.5s steps(4) infinite}
    @keyframes dots{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}}

    .recipe-card{background:white;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;animation:slideUp 0.4s ease-out}
    @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .recipe-header{background:linear-gradient(135deg,var(--terra) 0%,var(--terra-light) 100%);color:white;padding:1.5rem;position:relative}
    .recipe-header.fav-header{background:linear-gradient(135deg,var(--olive) 0%,var(--olive-light) 100%)}
    .recipe-header h2{font-family:'DM Serif Display',serif;font-size:1.5rem;font-weight:400;line-height:1.25;padding-right:2.5rem}
    .recipe-header .subtitle{opacity:0.85;font-size:0.85rem;margin-top:0.4rem}
    .recipe-meta{display:flex;gap:1rem;margin-top:1rem;font-size:0.78rem;opacity:0.9}
    .recipe-meta span{display:flex;align-items:center;gap:0.3rem}

    .heart-btn{position:absolute;top:1.2rem;right:1.2rem;width:2.5rem;height:2.5rem;border-radius:50%;border:none;background:rgba(255,255,255,0.2);backdrop-filter:blur(4px);cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
    .heart-btn:hover{background:rgba(255,255,255,0.35);transform:scale(1.1)}
    .heart-btn.saved{background:rgba(255,255,255,0.9)}.heart-btn.saving{pointer-events:none;opacity:0.6}
    @keyframes heartPop{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
    .heart-btn.pop{animation:heartPop 0.4s ease}
    .recipe-hearts{position:absolute;top:1.2rem;right:1rem;display:flex;gap:0.3rem}
    .heart-btn-mini{width:2.2rem;height:2.2rem;border-radius:50%;border:none;background:rgba(255,255,255,0.2);backdrop-filter:blur(4px);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all 0.3s;opacity:0.5}
    .heart-btn-mini:hover{background:rgba(255,255,255,0.35);transform:scale(1.1)}
    .heart-btn-mini.active{opacity:1;background:rgba(255,255,255,0.9);box-shadow:0 1px 4px rgba(0,0,0,0.15)}

    .recipe-tags{padding:1rem 1.5rem 0;display:flex;flex-wrap:wrap;gap:0.35rem}
    .recipe-tag{background:var(--cream);padding:0.25rem 0.6rem;border-radius:50px;font-size:0.7rem;color:var(--stone)}
    .recipe-nutrition{display:flex;margin:1rem 1.5rem;background:var(--cream);border-radius:var(--radius-sm);overflow:hidden}
    .nutrition-item{flex:1;text-align:center;padding:0.7rem 0.4rem}
    .nutrition-item:not(:last-child){border-right:1px solid var(--sand)}
    .nutrition-value{font-weight:600;font-size:0.95rem;color:var(--terra)}
    .nutrition-label{font-size:0.65rem;color:var(--stone);margin-top:0.15rem}
    .recipe-section{padding:1rem 1.5rem}
    .recipe-section-title{font-family:'DM Serif Display',serif;font-size:1.05rem;margin-bottom:0.7rem}
    .ingredient-list{list-style:none}
    .ingredient-list li{padding:0.45rem 0;border-bottom:1px solid var(--cream);font-size:0.85rem;display:flex;gap:0.5rem}
    .ingredient-list li:last-child{border:none}
    .ingredient-amount{font-weight:600;color:var(--terra);min-width:70px}
    .steps-list{list-style:none;counter-reset:steps}
    .steps-list li{counter-increment:steps;padding:0.6rem 0 0.6rem 2.2rem;position:relative;font-size:0.85rem;line-height:1.5}
    .steps-list li::before{content:counter(steps);position:absolute;left:0;top:0.55rem;width:1.5rem;height:1.5rem;background:var(--terra);color:white;border-radius:50%;font-size:0.7rem;font-weight:600;display:flex;align-items:center;justify-content:center}

    .recipe-tip,.health-note,.compat-note{margin:0 1.5rem 1rem;padding:0.8rem 1rem;border-radius:0 var(--radius-sm) var(--radius-sm) 0;font-size:0.8rem}
    .recipe-tip{background:linear-gradient(135deg,rgba(107,124,82,0.08),rgba(107,124,82,0.03));border-left:3px solid var(--olive)}
    .recipe-tip strong{color:var(--olive)}
    .health-note{background:linear-gradient(135deg,rgba(212,149,58,0.08),rgba(212,149,58,0.03));border-left:3px solid var(--amber)}
    .health-note strong{color:var(--amber)}
    .compat-note{background:rgba(196,94,58,0.06);border-left:3px solid var(--terra-light);font-size:0.78rem}

    .save-toast{position:fixed;top:1rem;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--charcoal);color:white;padding:0.8rem 1.5rem;border-radius:50px;font-size:0.85rem;font-weight:500;box-shadow:var(--shadow-lg);transition:transform 0.3s ease;z-index:100;white-space:nowrap}
    .save-toast.show{transform:translateX(-50%) translateY(0)}

    .link-btn{display:block;text-align:center;padding:0.7rem;margin:0 1.5rem 1rem;background:var(--cream);color:var(--terra);text-decoration:none;border-radius:var(--radius-sm);font-size:0.82rem;font-weight:600;transition:all 0.2s}
    .link-btn:hover{background:var(--sand)}
    .new-recipe-btn{width:100%;padding:0.9rem;background:white;color:var(--terra);border:2px solid var(--terra);border-radius:var(--radius);font-family:'DM Sans',sans-serif;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.2s;margin-top:1rem}
    .new-recipe-btn:hover{background:var(--terra);color:white}
    .new-recipe-btn.fav{color:var(--olive);border-color:var(--olive)}.new-recipe-btn.fav:hover{background:var(--olive);color:white}
    .back-btn{width:100%;padding:0.7rem;background:transparent;color:var(--stone);border:1.5px solid var(--sand);border-radius:var(--radius);font-family:'DM Sans',sans-serif;font-size:0.85rem;cursor:pointer;transition:all 0.2s;margin-top:0.5rem}
    .back-btn:hover{border-color:var(--stone);color:var(--charcoal)}
    .add-plan-btn{width:100%;padding:0.7rem;background:white;color:var(--amber);border:2px solid var(--amber);border-radius:var(--radius);font-family:'DM Sans',sans-serif;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s;margin-top:0.5rem}
    .add-plan-btn:hover{background:var(--amber);color:white}

    .fav-list{display:flex;flex-direction:column;gap:0.6rem}
    .fav-item{background:white;border-radius:var(--radius-sm);padding:0.9rem 1rem;box-shadow:var(--shadow);cursor:pointer;transition:all 0.2s;border-left:3px solid var(--olive)}
    .fav-item:hover{transform:translateY(-1px);box-shadow:var(--shadow-lg)}
    .fav-item-title{font-weight:600;font-size:0.9rem;margin-bottom:0.2rem}
    .fav-item-subtitle{font-size:0.78rem;color:var(--stone);margin-bottom:0.4rem}
    .fav-item-meta{display:flex;gap:0.5rem;flex-wrap:wrap}
    .fav-item-tag{font-size:0.65rem;background:var(--cream);padding:0.15rem 0.5rem;border-radius:50px;color:var(--stone)}
    .fav-item-note{font-size:0.72rem;color:var(--terra);margin-top:0.35rem;font-style:italic}
    .fav-count{text-align:center;font-size:0.78rem;color:var(--stone);margin-top:0.5rem}
    .inspiration-box{margin-top:1.5rem;padding:1rem;background:white;border-radius:var(--radius);box-shadow:var(--shadow)}
    .inspiration-links{display:flex;flex-direction:column;gap:0.3rem}
    .inspiration-link{color:var(--terra);text-decoration:none;font-size:0.82rem;padding:0.3rem 0}
    .error-card{background:white;border-radius:var(--radius);padding:2rem 1.5rem;text-align:center;box-shadow:var(--shadow)}
    .error-card .emoji{font-size:2rem;margin-bottom:0.7rem}
    .error-card p{color:var(--stone);font-size:0.85rem;margin-bottom:1rem}
    .error-card .error-detail{font-size:0.75rem;color:var(--sand);background:var(--cream);padding:0.5rem;border-radius:var(--radius-sm);margin-bottom:1rem;word-break:break-all}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn 0.2s}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .modal{background:white;border-radius:var(--radius) var(--radius) 0 0;padding:1.5rem;width:100%;max-width:480px;max-height:70vh;overflow-y:auto;animation:slideModal 0.3s ease}
    @keyframes slideModal{from{transform:translateY(100%)}to{transform:translateY(0)}}
    .modal h3{font-family:'DM Serif Display',serif;font-size:1.1rem;margin-bottom:1rem}
    .modal-days{display:flex;flex-direction:column;gap:0.5rem}
    .modal-day-btn{padding:0.8rem 1rem;border:1.5px solid var(--sand);border-radius:var(--radius-sm);background:white;text-align:left;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:0.85rem;font-weight:500;transition:all 0.2s;display:flex;justify-content:space-between;align-items:center}
    .modal-day-btn:hover{border-color:var(--terra);background:rgba(196,94,58,0.04)}
    .modal-day-count{font-size:0.72rem;color:var(--stone)}
    .modal-close{width:100%;padding:0.7rem;border:none;background:var(--cream);border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;color:var(--stone);font-size:0.85rem;cursor:pointer;margin-top:0.8rem}

    /* Weekly Plan */
    .plan-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem}
    .plan-header h2{font-family:'DM Serif Display',serif;font-size:1.3rem;font-weight:400}
    .week-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;background:white;border-radius:var(--radius);padding:0.5rem;box-shadow:var(--shadow)}
    .week-nav-btn{width:2.2rem;height:2.2rem;border-radius:50%;border:1.5px solid var(--sand);background:white;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all 0.2s;font-family:'DM Sans',sans-serif}
    .week-nav-btn:hover{border-color:var(--terra);color:var(--terra)}
    .week-nav-label{font-size:0.85rem;font-weight:600;color:var(--charcoal);text-align:center}
    .week-nav-label .week-type{font-size:0.7rem;font-weight:400;color:var(--stone);display:block;margin-top:0.1rem}
    .week-nav-label.current-week{color:var(--terra)}
    .week-nav-label.current-week .week-type{color:var(--terra);font-weight:600}
    .week-nav-label.other-week{color:var(--stone)}
    .week-nav-label.other-week .week-type{color:var(--sand)}
    .plan-action-btn{padding:0.4rem 0.8rem;border:1.5px solid var(--sand);border-radius:50px;background:white;font-size:0.75rem;cursor:pointer;font-family:'DM Sans',sans-serif;color:var(--stone);transition:all 0.2s}
    .plan-action-btn:hover{border-color:var(--terra);color:var(--terra)}

    .plan-empty{text-align:center;padding:3rem 1.5rem}
    .plan-empty .emoji{font-size:2.5rem;margin-bottom:0.7rem}
    .plan-empty p{color:var(--stone);font-size:0.9rem;margin-bottom:0.3rem}
    .plan-empty .hint{font-size:0.8rem;color:var(--sand)}

    .plan-day{margin-bottom:0.8rem}
    .plan-day-header{padding:0.5rem 0;border-bottom:1px solid var(--sand);margin-bottom:0.4rem;display:flex;justify-content:space-between;align-items:center}
    .plan-day-title{font-family:'DM Serif Display',serif;font-size:0.95rem;color:var(--charcoal)}
    .plan-day-date{font-size:0.72rem;color:var(--stone)}
    .plan-day.today .plan-day-title{color:var(--terra)}

    .plan-recipe{background:white;border-radius:var(--radius-sm);box-shadow:var(--shadow);margin-bottom:0.4rem;overflow:hidden}
    .plan-recipe-header{padding:0.8rem 1rem;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .plan-recipe-info{flex:1}
    .plan-recipe-title{font-weight:600;font-size:0.85rem}
    .plan-recipe-sub{font-size:0.72rem;color:var(--stone);margin-top:0.15rem}
    .plan-recipe-actions{display:flex;gap:0.3rem;align-items:center;flex-shrink:0;margin-left:0.5rem}
    .plan-recipe-toggle{width:1.8rem;height:1.8rem;border-radius:50%;border:none;background:var(--cream);cursor:pointer;font-size:0.7rem;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .plan-recipe-toggle:hover{background:var(--sand)}
    .plan-recipe-toggle.open{transform:rotate(180deg)}
    .plan-recipe-remove{width:1.8rem;height:1.8rem;border-radius:50%;border:none;background:var(--cream);cursor:pointer;font-size:0.75rem;display:flex;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0}
    .plan-recipe-remove:hover{background:var(--terra);color:white}

    .plan-recipe-detail{display:none;padding:0 1rem 1rem;border-top:1px solid var(--cream)}
    .plan-recipe-detail.open{display:block}
    .plan-recipe-detail .ingredient-list{margin-top:0.5rem}
    .plan-recipe-detail .ingredient-list li{font-size:0.8rem;padding:0.3rem 0}
    .plan-recipe-detail .ingredient-amount{min-width:60px;font-size:0.8rem}
    .plan-recipe-detail .steps-list{margin-top:0.5rem}
    .plan-recipe-detail .steps-list li{font-size:0.8rem;padding:0.4rem 0 0.4rem 2rem}
    .plan-recipe-detail .steps-list li::before{width:1.3rem;height:1.3rem;font-size:0.6rem;top:0.4rem}
    .plan-recipe-detail .recipe-tip{margin:0.5rem 0;font-size:0.75rem;padding:0.6rem 0.8rem}
    .plan-recipe-detail .link-btn{margin:0.5rem 0 0;padding:0.5rem;font-size:0.78rem}
    .plan-detail-label{font-size:0.7rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--stone);margin-top:0.7rem;margin-bottom:0.3rem}

    .plan-day-empty{padding:0.6rem;text-align:center;color:var(--sand);font-size:0.78rem;background:white;border-radius:var(--radius-sm);border:1px dashed var(--sand);cursor:pointer;transition:all 0.2s}
    .plan-day-empty:hover{border-color:var(--terra);color:var(--terra)}
    .plan-other-week .plan-day-header{opacity:0.5}
    .plan-other-week .plan-day-empty{opacity:0.5}
    .plan-summary{text-align:center;padding:1rem;margin-top:0.5rem;font-size:0.8rem;color:var(--stone)}

    /* Favorites Screen */
    .fav-screen-count{font-size:0.78rem;color:var(--stone)}
    .fav-section{margin-bottom:1.5rem}
    .fav-section-header{font-size:0.72rem;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--stone);margin-bottom:0.5rem;padding-left:0.2rem}
    .fav-cuisine-group{margin-bottom:1.5rem}
    .fav-cuisine-header{font-family:'DM Serif Display',serif;font-size:1.1rem;font-weight:400;color:var(--charcoal);margin-bottom:0.8rem;padding-bottom:0.4rem;border-bottom:1.5px solid var(--sand);display:flex;align-items:center;gap:0.5rem}
    .fav-cuisine-count{font-family:'DM Sans',sans-serif;font-size:0.65rem;background:var(--sand);color:var(--stone);padding:0.1rem 0.4rem;border-radius:50px}
    .fav-saved-item{background:white;border-radius:var(--radius-sm);box-shadow:var(--shadow);margin-bottom:0.4rem;overflow:hidden}
    .fav-saved-header{padding:0.8rem 1rem;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .fav-saved-info{flex:1}
    .fav-saved-title{font-weight:600;font-size:0.85rem}
    .fav-saved-sub{font-size:0.72rem;color:var(--stone);margin-top:0.15rem}
    .fav-saved-date{font-size:0.65rem;color:var(--sand);margin-top:0.1rem}
    .fav-saved-actions{display:flex;gap:0.3rem;align-items:center;flex-shrink:0;margin-left:0.5rem}
    .fav-saved-detail{display:none;padding:0 1rem 1rem;border-top:1px solid var(--cream)}
    .fav-saved-detail.open{display:block}
    .fav-empty{text-align:center;padding:3rem 1.5rem}
    .fav-empty .emoji{font-size:2.5rem;margin-bottom:0.7rem}
    .fav-empty p{color:var(--stone);font-size:0.9rem;margin-bottom:0.3rem}
    .fav-empty .hint{font-size:0.8rem;color:var(--sand)}
    .fav-ki-badge{display:inline-block;background:var(--terra);color:white;font-size:0.6rem;font-weight:700;padding:0.1rem 0.4rem;border-radius:50px;vertical-align:middle;margin-left:0.3rem}
    .fav-cuisine-tag{margin-right:0.3rem}
    .fav-zutaten,.fav-zubereitung{font-size:0.82rem;line-height:1.6;color:var(--charcoal);padding:0.3rem 0}
    .heart-toggles{display:flex;gap:0.25rem;margin-right:0.4rem}
    .heart-toggle{width:32px;height:32px;border:none;border-radius:50%;background:var(--cream);cursor:pointer;font-size:0.9rem;opacity:0.35;transition:all 0.2s;display:flex;align-items:center;justify-content:center;padding:0}
    .heart-toggle.active{opacity:1;background:white;box-shadow:0 1px 4px rgba(0,0,0,0.1);transform:scale(1.1)}
    .fav-filters{margin-bottom:1rem}
    .fav-filter-row{display:flex;gap:0.4rem;margin-bottom:0.5rem;flex-wrap:wrap}
    .fav-filter-btn{padding:0.45rem 0.8rem;border:1.5px solid var(--sand);border-radius:var(--radius-sm);background:white;font-family:'DM Sans',sans-serif;font-size:0.78rem;font-weight:500;color:var(--stone);cursor:pointer;transition:all 0.2s}
    .fav-filter-btn.active{border-color:var(--terra);color:var(--terra);background:rgba(196,94,58,0.06)}
    .fav-import-box{background:white;border-radius:var(--radius);padding:1rem;margin-bottom:1rem;box-shadow:var(--shadow)}
    .fav-import-row{display:flex;gap:0.5rem}
    .fav-import-input{flex:1;padding:0.6rem 0.8rem;border:1.5px solid var(--sand);border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-size:0.85rem;background:var(--warm);color:var(--charcoal)}
    .fav-import-input:focus{outline:none;border-color:var(--terra)}
    .fav-import-btn{width:44px;height:44px;border:none;border-radius:var(--radius-sm);background:var(--terra);color:white;font-size:1.3rem;font-weight:700;cursor:pointer;transition:all 0.2s;flex-shrink:0}
    .fav-import-btn:disabled{opacity:0.5;cursor:not-allowed}
    .fav-import-btn.loading{animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    .fav-import-status{font-size:0.78rem;color:var(--stone);margin-top:0.5rem;min-height:1.2em}
    .ai-save-bar{background:white;border-radius:var(--radius);padding:1rem;margin-top:0.5rem;box-shadow:var(--shadow);text-align:center}
    .ai-save-label{font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.06em;color:var(--stone);margin-bottom:0.6rem}
    .ai-save-btns{display:flex;gap:0.5rem;justify-content:center}
    .ai-save-btn{padding:0.6rem 1.2rem;border:2px solid var(--sand);border-radius:var(--radius);background:white;font-family:'DM Sans',sans-serif;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s}
    .ai-save-btn:hover{border-color:var(--terra);background:rgba(196,94,58,0.04)}
    .ai-save-btn.saving{opacity:0.6;cursor:not-allowed}
    .ai-save-btn.saved{border-color:var(--olive);background:rgba(107,124,82,0.08);color:var(--olive)}
    .ai-save-both{border-color:var(--amber)}
    .ingredient-input{width:100%;padding:0.75rem 1rem;border:1.5px solid var(--sand);border-radius:var(--radius);background:white;font-family:'DM Sans',sans-serif;font-size:0.85rem;color:var(--charcoal);transition:border-color 0.2s}
    .ingredient-input:focus{outline:none;border-color:var(--terra)}
    .ingredient-input::placeholder{color:var(--sand)}

    .footer{text-align:center;padding:2rem 1.5rem;color:var(--sand);font-size:0.7rem}
    .hidden{display:none !important}
    @media(min-width:520px){.container{padding:2rem}.header{padding:2.5rem 2rem 1.5rem}}
  </style>
</head>
<body>

  <header class="header">
    <span class="logo">ü•Ñ</span>
    <h1>Schipfie's Choice</h1>
    <p>Gesund kochen ‚Äî einfach gemacht</p>
  </header>

  <!-- ‚ïê‚ïê‚ïê SCREEN 1: REZEPTE ‚ïê‚ïê‚ïê -->
  <main class="container screen active mode-fav" id="screenRecipes">
    <div class="mode-toggle">
      <button class="mode-btn" onclick="setMode('ai')">‚ú® KI-Rezept</button>
      <button class="mode-btn active" onclick="setMode('favorites')">üìö Aus unseren Rezepten</button>
    </div>
    <section class="section">
      <div class="section-label">Wer isst mit?</div>
      <div class="profiles">
        <button class="profile-btn active" data-profile="lucas" onclick="toggleProfile('lucas')"><span class="emoji">ü¶ñ</span><div class="name">Luki's Choice</div><div class="badge">Fisch ok ¬∑ Viel Eiwei√ü</div></button>
        <button class="profile-btn active" data-profile="lola" onclick="toggleProfile('lola')"><span class="emoji">üç≠</span><div class="name">Lola's Choice</div><div class="badge">Vegetarisch ¬∑ Eisenreich</div></button>
      </div>
    </section>
    <section class="section">
      <div class="section-label">Zus√§tzliche Filter</div>
      <div class="chips">
        <button class="chip" data-filter="glutenfrei" onclick="toggleFilter(this)">Glutenfrei</button>
        <button class="chip" data-filter="kohlenhydratarm" onclick="toggleFilter(this)">Kohlenhydratarm</button>
        <button class="chip" data-filter="laktosefrei" onclick="toggleFilter(this)">Laktosefrei</button>
        <button class="chip" data-filter="salzarm" onclick="toggleFilter(this)">Salzarm</button>
        <button class="chip" data-filter="vegan" onclick="toggleFilter(this)">Vegan</button>
        <button class="chip" data-filter="zuckerfrei" onclick="toggleFilter(this)">Zuckerfrei</button>
      </div>
    </section>
    <section class="section" id="cuisineSection">
      <div class="section-label">K√ºchenstil</div>
      <div class="cuisine-grid">
        <button class="cuisine-card" data-cuisine="asiatisch" onclick="selectCuisine(this)"><span class="emoji">üçú</span><div class="label">Asiatisch</div></button>
        <button class="cuisine-card" data-cuisine="mediterran" onclick="selectCuisine(this)"><span class="emoji">ü´í</span><div class="label">Mediterran</div></button>
        <button class="cuisine-card" data-cuisine="orientalisch" onclick="selectCuisine(this)"><span class="emoji">üßÜ</span><div class="label">Orientalisch</div></button>
        <button class="cuisine-card" data-cuisine="oesterreichisch" onclick="selectCuisine(this)"><span class="emoji">üá¶üáπ</span><div class="label">√ñsterreichisch</div></button>
        <button class="cuisine-card" data-cuisine="comfort" onclick="selectCuisine(this)"><span class="emoji">üç≤</span><div class="label">Comfort</div></button>
        <button class="cuisine-card active" data-cuisine="surprise" onclick="selectCuisine(this)"><span class="emoji">üé≤</span><div class="label">√úberrasch mich</div></button>
      </div>
    </section>
    <section class="section" id="mealTypeSection">
      <div class="section-label">Was soll's sein? <span style="font-weight:400;text-transform:none;letter-spacing:0">(Mehrfachauswahl m√∂glich)</span></div>
      <div class="meal-grid">
        <button class="meal-card" data-meal="vorspeise" onclick="toggleMealType(this)"><span class="emoji">ü•ó</span><div class="label">Vorspeise / Salat</div></button>
        <button class="meal-card" data-meal="suppe" onclick="toggleMealType(this)"><span class="emoji">üç≤</span><div class="label">Suppe</div></button>
        <button class="meal-card active" data-meal="hauptgericht" onclick="toggleMealType(this)"><span class="emoji">üçΩ</span><div class="label">Hauptgericht</div></button>
        <button class="meal-card" data-meal="dessert_gesund" onclick="toggleMealType(this)"><span class="emoji">üçì</span><div class="label">Dessert (gesund)</div></button>
        <button class="meal-card" data-meal="dessert_ungesund" onclick="toggleMealType(this)"><span class="emoji">üç∞</span><div class="label">Dessert (Genuss)</div></button>
        <button class="meal-card" data-meal="snack" onclick="toggleMealType(this)"><span class="emoji">ü•ú</span><div class="label">Snack</div></button>
        <button class="meal-card" data-meal="smoothie" onclick="toggleMealType(this)"><span class="emoji">ü•§</span><div class="label">Smoothie</div></button>
      </div>
    </section>
    <section class="section" id="ingredientSection">
      <div class="section-label">Zutat verkochen? <span style="font-weight:400;text-transform:none;letter-spacing:0">(optional)</span></div>
      <input type="text" id="ingredientInput" class="ingredient-input" placeholder="z.B. Aubergine, Linsen, Lachs‚Ä¶" oninput="state.ingredient=this.value.trim()">
    </section>
    <section class="section"><button class="generate-btn fav-btn" id="generateBtn" onclick="handleGenerate()">üìö Zeig mir ein Rezept!</button></section>
    <section id="result"></section>
    <footer class="footer">Schipfie's Choice v8.5 ¬∑ Made with ü§ç in Berlin Mitte</footer>
  </main>

  <!-- ‚ïê‚ïê‚ïê SCREEN 2: WOCHENPLAN ‚ïê‚ïê‚ïê -->
  <div class="container screen" id="screenPlan">
    <div class="plan-header">
      <h2>üìÖ Weekly Plan</h2>
      <button class="plan-action-btn" onclick="clearCurrentWeekPlan()">üóë Leeren</button>
    </div>
    <div class="week-nav">
      <button class="week-nav-btn" onclick="shiftWeek(-1)">‚Üê</button>
      <div class="week-nav-label" id="planWeekLabel"></div>
      <button class="week-nav-btn" onclick="shiftWeek(1)">‚Üí</button>
    </div>
    <div id="planContent"></div>
    <footer class="footer">Schipfie's Choice v8.5 ¬∑ Made with ü§ç in Berlin Mitte</footer>
  </div>

  <!-- ‚ïê‚ïê‚ïê SCREEN 3: FAVORITES (geherzt) ‚ïê‚ïê‚ïê -->
  <div class="container screen" id="screenFavorites">
    <div class="plan-header">
      <h2>üìö Rezeptdatenbank</h2>
      <div class="fav-screen-count" id="favScreenCount"></div>
    </div>
    <div class="fav-import-box">
      <div class="section-label">Neues Rezept hinzuf√ºgen</div>
      <div class="fav-import-row">
        <input type="url" id="importUrlInput" class="fav-import-input" placeholder="Rezept-URL einf√ºgen‚Ä¶">
        <button class="fav-import-btn" id="importBtn" onclick="importRecipeFromUrl()">+</button>
      </div>
      <div class="fav-import-status" id="importStatus"></div>
    </div>
    <div class="fav-filters">
      <div class="fav-filter-row">
        <button class="fav-filter-btn" data-favfilter="lola" onclick="toggleFavFilter('lola',this)">üç≠ Loli</button>
        <button class="fav-filter-btn" data-favfilter="luki" onclick="toggleFavFilter('luki',this)">ü¶ñ Luki</button>
      </div>
    </div>
    <div id="favContent"></div>
    <footer class="footer">Schipfie's Choice v8.5 ¬∑ Made with ü§ç in Berlin Mitte</footer>
  </div>

  <nav class="bottom-nav">
    <button class="nav-tab active" onclick="switchScreen('recipes')"><span class="nav-icon">ü•Ñ</span><span class="nav-label">Rezepte</span></button>
    <button class="nav-tab" onclick="switchScreen('favorites')"><span class="nav-icon">üìö</span><span class="nav-label">Rezepte<span class="nav-badge" id="favBadge" style="display:none">0</span></span></button>
    <button class="nav-tab" onclick="switchScreen('plan')"><span class="nav-icon">üìÖ</span><span class="nav-label">Weekly Plan<span class="nav-badge" id="planBadge" style="display:none">0</span></span></button>
  </nav>

  <div class="save-toast" id="saveToast"></div>
  <div id="modalContainer"></div>

  <!-- Favorites now loaded from Notion API -->
  <script>
    const state={mode:'favorites',profiles:new Set(["lucas","lola"]),filters:{},cuisine:"surprise",mealTypes:new Set(["hauptgericht"]),currentRecipe:null,screen:'recipes',ingredient:''};
    const DAY_NAMES=['Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag','Sonntag'];

    // ‚îÄ‚îÄ Screen Navigation ‚îÄ‚îÄ
    function switchScreen(s){
      state.screen=s;
      document.querySelectorAll('.screen').forEach(el=>el.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
      if(s==='recipes'){
        document.getElementById('screenRecipes').classList.add('active');
        document.querySelectorAll('.nav-tab')[0].classList.add('active');
      } else if(s==='favorites'){
        document.getElementById('screenFavorites').classList.add('active');
        document.querySelectorAll('.nav-tab')[1].classList.add('active');
        renderSavedFavorites();
      } else {
        document.getElementById('screenPlan').classList.add('active');
        document.querySelectorAll('.nav-tab')[2].classList.add('active');
        renderPlan();
      }
      window.scrollTo(0,0);
    }

    // ‚îÄ‚îÄ Notion Favorites Cache ‚îÄ‚îÄ
    let notionFavorites = []; // Loaded from Notion API
    let favoritesLoaded = false;

    async function loadFavoritesFromNotion() {
      try {
        const res = await fetch('/api/get-favorites');
        if (!res.ok) throw new Error('API Fehler');
        notionFavorites = await res.json();
        favoritesLoaded = true;
        // Cache locally for offline/fast access
        localStorage.setItem('schipfie-notion-cache', JSON.stringify(notionFavorites));
        updateFavBadge();
        return notionFavorites;
      } catch(e) {
        console.warn('Notion fetch failed, using cache:', e);
        try {
          notionFavorites = JSON.parse(localStorage.getItem('schipfie-notion-cache')) || [];
        } catch(e2) { notionFavorites = []; }
        favoritesLoaded = true;
        updateFavBadge();
        return notionFavorites;
      }
    }

    // Map Notion cuisine names to app cuisine keys
    function mapCuisineFromNotion(name) {
      const map = {'Asiatisch':'asiatisch','Mediterran':'mediterran','Orientalisch':'orientalisch','√ñsterreichisch':'oesterreichisch','Comfort':'comfort','Andere':'other'};
      return map[name] || 'comfort';
    }
    function mapCuisineToNotion(key) {
      const map = {asiatisch:'Asiatisch',mediterran:'Mediterran',orientalisch:'Orientalisch',oesterreichisch:'√ñsterreichisch',comfort:'Comfort',surprise:'Andere'};
      return map[key] || 'Comfort';
    }

    function updateFavBadge(){
      const total = notionFavorites.length;
      const badge = document.getElementById('favBadge');
      if(total>0){badge.style.display='inline-block';badge.textContent=total}else{badge.style.display='none'}
    }

    function toggleFavDetail(id){
      const el=document.getElementById(id);const btn=document.querySelector(`[data-toggle="${id}"]`);
      if(el){el.classList.toggle('open');if(btn)btn.classList.toggle('open')}
    }

    let favFilterLola = false;
    let favFilterLuki = false;

    function toggleFavFilter(f, btn) {
      if(f === 'lola') favFilterLola = !favFilterLola;
      else if(f === 'luki') favFilterLuki = !favFilterLuki;
      btn.classList.toggle('active');
      renderSavedFavorites();
    }

    function getFilteredFavorites() {
      // No filter active = show all
      if(!favFilterLola && !favFilterLuki) return [...notionFavorites];
      return notionFavorites.filter(f => {
        const h = f.geherztVon || [];
        if(favFilterLola && favFilterLuki) {
          // Beide aktiv: nur Rezepte die BEIDE geherzt haben
          return h.includes('Lola') && h.includes('Luki');
        }
        if(favFilterLola) return h.includes('Lola');
        if(favFilterLuki) return h.includes('Luki');
        return false;
      });
    }

    function renderSavedFavorites(){
      const el=document.getElementById('favContent');
      const filtered = getFilteredFavorites();
      const favCount = notionFavorites.filter(f => f.source === 'Favorit').length;
      const kiCount = notionFavorites.filter(f => f.source === 'KI-generiert').length;
      const manualCount = notionFavorites.length - favCount - kiCount;
      document.getElementById('favScreenCount').textContent = notionFavorites.length ? 
        `${notionFavorites.length} Rezept${notionFavorites.length>1?'e':''} (${favCount} Favoriten${kiCount?' ¬∑ '+kiCount+' KI':''}${manualCount?' ¬∑ '+manualCount+' Manuell':''})` : '';

      if(!favoritesLoaded){
        el.innerHTML='<div class="fav-empty"><div class="emoji">‚è≥</div><p>Lade Favoriten...</p></div>';
        return;
      }
      if(notionFavorites.length===0){
        el.innerHTML=`<div class="fav-empty"><div class="emoji">‚ù§Ô∏è</div><p>Noch keine Favoriten gespeichert</p><p class="hint">Herze Rezepte mit ü§ç um sie hier zu sammeln</p><button class="generate-btn" style="margin-top:1rem;max-width:280px;margin-left:auto;margin-right:auto;display:block" onclick="switchScreen('recipes')">ü•Ñ Rezepte entdecken</button></div>`;
        return;
      }
      if(filtered.length===0){
        el.innerHTML=`<div class="fav-empty"><div class="emoji">ü§∑</div><p>Keine Rezepte mit diesem Filter.</p></div>`;
        return;
      }

      let h='';

      const mealOrder=[
        {key:'vorspeise',label:'ü•ó Vorspeise / Salat'},
        {key:'suppe',label:'üç≤ Suppe'},
        {key:'hauptgericht',label:'üçΩ Hauptgericht'},
        {key:'dessert_gesund',label:'üçì Dessert (gesund)'},
        {key:'dessert_ungesund',label:'üç∞ Dessert (Genuss)'},
        {key:'snack',label:'ü•ú Snack'},
        {key:'smoothie',label:'ü•§ Smoothie'},
        {key:'other',label:'ü•Ñ Sonstige'}
      ];
      const grouped={};
      filtered.forEach((f,i)=>{
        const type=f.mealType||'other';
        if(!grouped[type])grouped[type]=[];
        grouped[type].push({...f,origIdx:i});
      });
      mealOrder.forEach(cat=>{
        const items=grouped[cat.key];
        if(!items||items.length===0)return;
        const sorted=items.sort((a,b)=>a.title.localeCompare(b.title,'de'));
        h+=`<div class="fav-section"><div class="fav-section-header">${cat.label}</div>`;
        sorted.forEach(r=>{h+=renderFavItem(r)});
        h+=`</div>`;
      });
      el.innerHTML=h;
    }

    function renderFavItem(r){
      const detailId=`fav-detail-${r.origIdx}`;
      const hasZutaten = r.zutaten && r.zutaten.trim().length > 0;
      const hasZubereitung = r.zubereitung && r.zubereitung.trim().length > 0;
      const hasDetail = hasZutaten || hasZubereitung || r.link;
      const isKI = r.source === 'KI-generiert';
      const borderColor = isKI ? 'border-left:3px solid var(--terra)' : 'border-left:3px solid var(--olive)';
      const sourceLabel = isKI ? '<span class="fav-ki-badge">‚ú® KI</span>' : '';
      const cuisineEmojis={asiatisch:'üçú',mediterran:'ü´í',orientalisch:'üßÜ',oesterreichisch:'üá¶üáπ',comfort:'üç≤'};
      const cKey = mapCuisineFromNotion(r.cuisine);
      const cuisineTag = cuisineEmojis[cKey] ? `<span class="fav-cuisine-tag">${cuisineEmojis[cKey]}</span>` : '';
      const hearts = (r.geherztVon||[]);
      const loliHearted = hearts.includes('Lola');
      const lukiHearted = hearts.includes('Luki');
      const heartDisplay = (loliHearted || lukiHearted) ? 
        `${loliHearted?'üç≠':''}${lukiHearted?'ü¶ñ':''}` : '';

      let h=`<div class="fav-saved-item" style="${borderColor}"><div class="fav-saved-header" ${hasDetail?`onclick="toggleFavDetail('${detailId}')"`:''}><div class="fav-saved-info"><div class="fav-saved-title">${cuisineTag}${r.title} ${sourceLabel}</div>${r.subtitle?`<div class="fav-saved-sub">${r.subtitle}</div>`:''}${r.prepTime?`<div class="fav-saved-sub">‚è± ${r.prepTime} Min ${heartDisplay?'¬∑ '+heartDisplay:''}</div>`:`${heartDisplay?`<div class="fav-saved-sub">${heartDisplay}</div>`:''}`}</div><div class="fav-saved-actions"><div class="heart-toggles" onclick="event.stopPropagation()"><button class="heart-toggle ${loliHearted?'active':''}" onclick="toggleHeart('${r.id}','Lola',this)" title="Loli herzt">üç≠</button><button class="heart-toggle ${lukiHearted?'active':''}" onclick="toggleHeart('${r.id}','Luki',this)" title="Luki herzt">ü¶ñ</button></div>${hasDetail?`<button class="plan-recipe-toggle" data-toggle="${detailId}" onclick="event.stopPropagation();toggleFavDetail('${detailId}')">‚ñº</button>`:''}</div></div>`;
      if(hasDetail){
        h+=`<div class="fav-saved-detail" id="${detailId}">`;
        if(hasZutaten){
          h+=`<div class="plan-detail-label">Zutaten</div><div class="fav-zutaten">${r.zutaten.replace(/\n/g,'<br>')}</div>`;
        }
        if(hasZubereitung){
          h+=`<div class="plan-detail-label">Zubereitung</div><div class="fav-zubereitung">${r.zubereitung.replace(/\n/g,'<br>')}</div>`;
        }
        if(r.tipps)h+=`<div class="recipe-tip"><strong>üí°</strong> ${r.tipps}</div>`;
        if(r.healthNote)h+=`<div class="health-note"><strong>üåø</strong> ${r.healthNote}</div>`;
        if(r.link)h+=`<a class="link-btn" href="${r.link}" target="_blank" onclick="event.stopPropagation()">üìñ Originalrezept</a>`;
        h+=`</div>`;
      }
      h+=`</div>`;
      return h;
    }

    // ‚îÄ‚îÄ Week Calculation ‚îÄ‚îÄ
    let weekOffset=0; // 0=current, -1=last, +1=next

    function getMondayOfWeek(offset){
      const now=new Date();const day=now.getDay();
      const diffToMonday=(day===0?-6:1-day);
      const mon=new Date(now);mon.setDate(now.getDate()+diffToMonday+(offset*7));mon.setHours(0,0,0,0);
      return mon;
    }
    function toLocalDateKey(d){
      return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    }
    function getWeekDates(offset){
      const mon=getMondayOfWeek(offset||0);
      return DAY_NAMES.map((name,i)=>{
        const d=new Date(mon);d.setDate(mon.getDate()+i);
        return{name,date:d,dateStr:d.toLocaleDateString('de-DE',{day:'numeric',month:'short'}),key:toLocalDateKey(d)};
      });
    }
    function getWeekKey(offset){return toLocalDateKey(getMondayOfWeek(offset||0))}
    function isToday(dateKey){return toLocalDateKey(new Date())===dateKey}
    function shiftWeek(dir){weekOffset=Math.max(-1,Math.min(1,weekOffset+dir));renderPlan()}

    // ‚îÄ‚îÄ Plan Storage (Notion-synced with localStorage cache) ‚îÄ‚îÄ
    function getAllPlans(){try{return JSON.parse(localStorage.getItem('schipfie-plans'))||{}}catch(e){return{}}}
    function saveAllPlans(plans){localStorage.setItem('schipfie-plans',JSON.stringify(plans));updateBadge()}
    function getPlanDays(offset){
      const plans=getAllPlans();const key=getWeekKey(offset||0);
      return plans[key]||{};
    }
    function savePlanDays(days,offset){
      const plans=getAllPlans();const key=getWeekKey(offset||0);
      plans[key]=days;
      const twoWeeksAgo=toLocalDateKey(getMondayOfWeek(-2));
      Object.keys(plans).forEach(k=>{if(k<twoWeeksAgo)delete plans[k]});
      saveAllPlans(plans);
    }
    function updateBadge(){
      const currentDays=getPlanDays(0);
      const total=Object.values(currentDays).reduce((s,d)=>s+d.length,0);
      const badge=document.getElementById('planBadge');
      if(total>0){badge.style.display='inline-block';badge.textContent=total}else{badge.style.display='none'}
    }

    function addRecipeToPlan(recipe,dayKey,offset){
      const days=getPlanDays(offset||0);
      if(!days[dayKey])days[dayKey]=[];
      // Convert AI recipe arrays to text if needed
      let zutaten = recipe.zutaten || '';
      let zubereitung = recipe.zubereitung || '';
      let tipps = recipe.tipps || recipe.tips || '';
      if(!zutaten && recipe.ingredients && recipe.ingredients.length){
        zutaten = recipe.ingredients.map(i=>`${i.amount} ${i.unit||''} ${i.name}`.trim()).join('\n');
      }
      if(!zubereitung && recipe.steps && recipe.steps.length){
        zubereitung = recipe.steps.map((s,i)=>`${i+1}. ${s}`).join('\n');
      }
      const entry = {
        title:recipe.title||'Rezept',subtitle:recipe.subtitle||'',prepTime:recipe.prepTime||'',
        link:recipe.link||null,zutaten,zubereitung,tipps,
        id:recipe.id||('ai-'+Date.now()),source:recipe.source||'KI-generiert',
        notionId:recipe.id||null, planEntryId:null
      };
      days[dayKey].push(entry);
      savePlanDays(days,offset||0);
      document.getElementById('modalContainer').innerHTML='';
      const week=getWeekDates(offset||0);
      const dayName=week.find(d=>d.key===dayKey)?.name||dayKey;
      showToast(`‚úÖ "${recipe.title}" ‚Üí ${dayName}`);

      // Sync to Notion in background
      const weekDates=getWeekDates(offset||0);
      const dayInfo=weekDates.find(d=>d.key===dayKey);
      if(dayInfo && recipe.id){
        const monday=getMondayOfWeek(offset||0);
        const kwNum=getWeekNumber(monday);
        fetch('/api/save-plan',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            datum:dayKey,
            rezeptId:recipe.id,
            tag:`${dayInfo.name} ${dayInfo.dateStr}`,
            woche:`KW${kwNum} ${monday.getFullYear()}`,
            notiz:''
          })
        }).then(res=>res.json()).then(data=>{
          if(data.id){
            // Store the Notion plan entry ID for later deletion
            const d=getPlanDays(offset||0);
            if(d[dayKey]){
              const last=d[dayKey][d[dayKey].length-1];
              if(last && last.title===entry.title) last.planEntryId=data.id;
              savePlanDays(d,offset||0);
            }
          }
        }).catch(e=>console.warn('Plan Notion sync failed:',e));
      }
    }

    function getWeekNumber(d){
      const date=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));
      date.setUTCDate(date.getUTCDate()+4-(date.getUTCDay()||7));
      const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1));
      return Math.ceil((((date-yearStart)/86400000)+1)/7);
    }

    async function loadPlanFromNotion(offset){
      try{
        const monday=getMondayOfWeek(offset||0);
        const weekStart=toLocalDateKey(monday);
        const res=await fetch(`/api/get-plan?weekStart=${weekStart}`);
        if(!res.ok)return;
        const entries=await res.json();
        if(!entries.length)return;

        // Merge Notion entries into local plan
        const days=getPlanDays(offset||0);
        const existingPlanIds=new Set();
        Object.values(days).forEach(arr=>arr.forEach(r=>{if(r.planEntryId)existingPlanIds.add(r.planEntryId)}));

        entries.forEach(entry=>{
          if(!entry.datum)return;
          const dayKey=entry.datum;
          if(existingPlanIds.has(entry.id))return; // already tracked
          // Find recipe details from notionFavorites
          entry.rezeptIds.forEach(rid=>{
            const recipe=notionFavorites.find(f=>f.id===rid);
            if(!recipe)return;
            // Check if recipe already exists for this day (by recipe id)
            if(days[dayKey]&&days[dayKey].some(r=>r.notionId===rid))return;
            if(!days[dayKey])days[dayKey]=[];
            days[dayKey].push({
              title:recipe.title,subtitle:recipe.subtitle||'',prepTime:recipe.prepTime||'',
              link:recipe.link||null,zutaten:recipe.zutaten||'',zubereitung:recipe.zubereitung||'',
              tipps:recipe.tipps||'',id:recipe.id,source:recipe.source||'Favorit',
              notionId:recipe.id, planEntryId:entry.id
            });
          });
        });
        savePlanDays(days,offset||0);
      }catch(e){console.warn('Plan load from Notion failed:',e)}
    }

    function removePlanRecipe(dayKey,idx){
      const days=getPlanDays(weekOffset);
      if(days[dayKey]){
        const removed=days[dayKey][idx];
        days[dayKey].splice(idx,1);
        if(days[dayKey].length===0)delete days[dayKey];
        // Delete from Notion if we have the plan entry ID
        if(removed && removed.planEntryId){
          fetch('/api/delete-plan',{method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({planEntryId:removed.planEntryId})
          }).catch(e=>console.warn('Notion delete failed:',e));
        }
      }
      savePlanDays(days,weekOffset);renderPlan();
    }

    function clearCurrentWeekPlan(){
      if(!confirm('Wochenplan f√ºr diese Woche wirklich leeren?'))return;
      // Delete all entries from Notion for this week
      const monday=getMondayOfWeek(weekOffset);
      const weekStart=toLocalDateKey(monday);
      fetch('/api/delete-plan',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({deleteAll:true,weekStart})
      }).catch(e=>console.warn('Notion clear failed:',e));
      savePlanDays({},weekOffset);renderPlan();
    }

    function togglePlanDetail(id){
      const el=document.getElementById(id);const btn=document.querySelector(`[data-toggle="${id}"]`);
      if(el){el.classList.toggle('open');if(btn)btn.classList.toggle('open')}
    }

    function showDayPicker(){
      const recipe=state.currentRecipe;if(!recipe){showToast('‚ùå Kein Rezept ausgew√§hlt');return}
      // Show current week + next week
      const weeks=[
        {offset:0,label:'Diese Woche'},
        {offset:1,label:'N√§chste Woche'}
      ];
      let h=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal"><h3>üìÖ Zu welchem Tag hinzuf√ºgen?</h3><div class="modal-days">`;
      weeks.forEach(w=>{
        const week=getWeekDates(w.offset);const days=getPlanDays(w.offset);
        h+=`<div style="font-size:0.72rem;font-weight:600;color:var(--stone);text-transform:uppercase;letter-spacing:0.08em;margin:0.6rem 0 0.3rem">${w.label}</div>`;
        week.forEach(d=>{
          const count=(days[d.key]||[]).length;
          h+=`<button class="modal-day-btn" onclick="addRecipeToPlan(state.currentRecipe,'${d.key}',${w.offset})"><span>${d.name}, ${d.dateStr}</span><span class="modal-day-count">${count?count+' Rezept'+(count>1?'e':''):'leer'}</span></button>`;
        });
      });
      h+=`</div><button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Abbrechen</button></div></div>`;
      document.getElementById('modalContainer').innerHTML=h;
    }

    function renderPlan(){
      const week=getWeekDates(weekOffset);const days=getPlanDays(weekOffset);const el=document.getElementById('planContent');
      const total=Object.values(days).reduce((s,d)=>s+d.length,0);

      // Load from Notion in background (merge any new entries)
      loadPlanFromNotion(weekOffset).then(()=>{
        const updatedDays=getPlanDays(weekOffset);
        const updatedTotal=Object.values(updatedDays).reduce((s,d)=>s+d.length,0);
        if(updatedTotal!==total) renderPlan(); // re-render if new data
      });

      // Week label with type
      const weekType=weekOffset===-1?'Letzte Woche':weekOffset===0?'Diese Woche':'N√§chste Woche';
      const labelEl=document.getElementById('planWeekLabel');
      labelEl.innerHTML=`${week[0].dateStr} ‚Äì ${week[6].dateStr}<span class="week-type">${weekType}</span>`;
      labelEl.className='week-nav-label '+(weekOffset===0?'current-week':'other-week');

      const isOtherWeek=weekOffset!==0;

      // Always show all 7 days
      let h='';
      week.forEach(d=>{
        const recipes=days[d.key]||[];
        const todayClass=isToday(d.key)?' today':'';
        const otherClass=isOtherWeek?' plan-other-week':'';
        h+=`<div class="plan-day${todayClass}${otherClass}"><div class="plan-day-header"><div class="plan-day-title">${d.name}</div><div class="plan-day-date">${d.dateStr}</div></div>`;
        if(recipes.length===0){
          h+=`<div class="plan-day-empty" onclick="switchScreen('recipes')">+ Rezept finden</div>`;
        } else {
          recipes.forEach((r,ri)=>{
            const detailId=`detail-${d.key}-${ri}`;
            const hasZutaten=r.zutaten&&r.zutaten.trim().length>0;
            const hasZubereitung=r.zubereitung&&r.zubereitung.trim().length>0;
            const hasDetail=hasZutaten||hasZubereitung||r.link;
            const isKI=r.source==='KI-generiert';
            const borderStyle=isKI?'border-left:3px solid var(--terra)':'border-left:3px solid var(--olive)';
            const kiBadge=isKI?'<span class="fav-ki-badge">‚ú® KI</span>':'';
            h+=`<div class="plan-recipe" style="${borderStyle}"><div class="plan-recipe-header" ${hasDetail?`onclick="togglePlanDetail('${detailId}')"`:''}><div class="plan-recipe-info"><div class="plan-recipe-title">${r.title} ${kiBadge}</div>${r.prepTime?`<div class="plan-recipe-sub">‚è± ${r.prepTime} Min</div>`:''}</div><div class="plan-recipe-actions">${hasDetail?`<button class="plan-recipe-toggle" data-toggle="${detailId}" onclick="event.stopPropagation();togglePlanDetail('${detailId}')">‚ñº</button>`:''}<button class="plan-recipe-remove" onclick="event.stopPropagation();removePlanRecipe('${d.key}',${ri})" title="Entfernen">‚úï</button></div></div>`;
            if(hasDetail){
              h+=`<div class="plan-recipe-detail" id="${detailId}">`;
              if(hasZutaten){
                h+=`<div class="plan-detail-label">Zutaten</div><div class="fav-zutaten">${r.zutaten.replace(/\n/g,'<br>')}</div>`;
              }
              if(hasZubereitung){
                h+=`<div class="plan-detail-label">Zubereitung</div><div class="fav-zubereitung">${r.zubereitung.replace(/\n/g,'<br>')}</div>`;
              }
              if(r.tipps)h+=`<div class="recipe-tip"><strong>üí°</strong> ${r.tipps}</div>`;
              if(r.link)h+=`<a class="link-btn" href="${r.link}" target="_blank" onclick="event.stopPropagation()">üìñ Originalrezept</a>`;
              h+=`</div>`;
            }
            h+=`</div>`;
          });
        }
        h+=`</div>`;
      });
      if(total>0)h+=`<div class="plan-summary">${total} Rezept${total>1?'e':''} ${weekType.toLowerCase()}</div>`;
      el.innerHTML=h;
    }

    // ‚îÄ‚îÄ Recipe Screen Logic ‚îÄ‚îÄ
    function setMode(m){
      state.mode=m;document.querySelectorAll('.mode-btn').forEach((b,i)=>b.classList.toggle('active',(i===0&&m==='ai')||(i===1&&m==='favorites')));
      const screen=document.getElementById('screenRecipes');
      screen.classList.toggle('mode-ai',m==='ai');
      screen.classList.toggle('mode-fav',m==='favorites');
      const btn=document.getElementById('generateBtn');
      if(m==='ai'){btn.textContent='Was kochen wir heute?';btn.classList.remove('fav-btn')}else{btn.textContent='üìö Zeig mir ein Rezept!';btn.classList.add('fav-btn')}
      document.getElementById('result').innerHTML='';
    }
    function toggleProfile(n){if(state.profiles.has(n)){if(state.profiles.size>1)state.profiles.delete(n)}else state.profiles.add(n);document.querySelectorAll('.profile-btn').forEach(b=>b.classList.toggle('active',state.profiles.has(b.dataset.profile)))}
    function toggleFilter(el){el.classList.toggle('active');state.filters[el.dataset.filter]=el.classList.contains('active')}
    function selectCuisine(el){document.querySelectorAll('.cuisine-card').forEach(c=>c.classList.remove('active'));el.classList.add('active');state.cuisine=el.dataset.cuisine}
    function toggleMealType(el){
      const meal=el.dataset.meal;
      if(state.mealTypes.has(meal)){
        if(state.mealTypes.size>1) state.mealTypes.delete(meal);
      } else {
        state.mealTypes.add(meal);
      }
      document.querySelectorAll('.meal-card').forEach(c=>c.classList.toggle('active',state.mealTypes.has(c.dataset.meal)));
    }
    function handleGenerate(){state.mode==='ai'?generateRecipe():showRandomFavorite()}
    function getCompatibleFavorites(){
      const lucasOnly=state.profiles.has('lucas')&&!state.profiles.has('lola');
      const ingredientFilter = state.ingredient ? state.ingredient.toLowerCase() : '';
      return notionFavorites.filter(f=>{
        if(lucasOnly){
          const pf=f.passtFuer||[];
          if(!pf.includes('Luki')&&!pf.includes('Beide'))return false;
        }
        if(f.mealType&&!state.mealTypes.has(f.mealType))return false;
        if(state.cuisine!=='surprise'){
          const fCuisine=mapCuisineFromNotion(f.cuisine);
          if(fCuisine&&fCuisine!==state.cuisine)return false;
        }
        if(ingredientFilter && f.zutaten){
          if(!f.zutaten.toLowerCase().includes(ingredientFilter))return false;
        } else if(ingredientFilter && !f.zutaten){
          return false;
        }
        return true;
      });
    }

    function showRandomFavorite(){
      if(!favoritesLoaded || notionFavorites.length === 0) {
        const result = document.getElementById('result');
        result.innerHTML='<div class="loading"><span class="loading-spoon">ü•Ñ</span><p>Lade Favoriten<span class="loading-dots"></span></p></div>';
        loadFavoritesFromNotion().then(() => {
          const c = getCompatibleFavorites();
          if(!c.length){result.innerHTML='<div class="error-card"><div class="emoji">ü§∑</div><p>Noch keine Favoriten in dieser Kategorie.</p><button class="new-recipe-btn" onclick="setMode(\'ai\');handleGenerate()">‚ú® KI-Rezept generieren</button></div>';return}
          renderFavorite(c[Math.floor(Math.random()*c.length)]);
        });
        return;
      }
      const c=getCompatibleFavorites();
      if(!c.length){document.getElementById('result').innerHTML='<div class="error-card"><div class="emoji">ü§∑</div><p>Noch keine Favoriten in dieser Kategorie.</p><button class="new-recipe-btn" onclick="setMode(\'ai\');handleGenerate()">‚ú® KI-Rezept generieren</button></div>';return}
      renderFavorite(c[Math.floor(Math.random()*c.length)]);
    }
    function showAllFavorites(){
      const c=getCompatibleFavorites();const result=document.getElementById('result');
      const cuisineEmojis={asiatisch:'üçú',mediterran:'ü´í',orientalisch:'üßÜ',oesterreichisch:'üá¶üáπ',comfort:'üç≤'};
      let h='<div class="fav-list">';
      c.forEach(f=>{
        const tags=(f.tags||[]).map(t=>`<span class="fav-item-tag">${t}</span>`).join('');
        const cKey=mapCuisineFromNotion(f.cuisine);
        const cEmoji=cuisineEmojis[cKey]||'';
        h+=`<div class="fav-item" onclick="renderFavoriteById('${f.id}')"><div class="fav-item-title">${cEmoji} ${f.title}</div><div class="fav-item-subtitle">${f.subtitle||''}</div><div class="fav-item-meta">${tags}</div></div>`;
      });
      h+=`</div><div class="fav-count">${c.length} Rezepte</div>`;
      result.innerHTML=h;result.scrollIntoView({behavior:'smooth',block:'start'});
    }
    function renderFavoriteById(id){renderFavorite(notionFavorites.find(r=>r.id===id))}

    function renderFavorite(r){
      if(!r)return;
      state.currentRecipe={...r,source:r.source||'Favorit',profiles:Array.from(state.profiles)};
      const result=document.getElementById('result');
      const hasZutaten=r.zutaten&&r.zutaten.trim().length>0;
      const hasZubereitung=r.zubereitung&&r.zubereitung.trim().length>0;
      const both=state.profiles.has('lucas')&&state.profiles.has('lola');
      const tags=(r.tags||[]).map(t=>`<span class="recipe-tag">${t}</span>`).join('');
      const loliH = (r.geherztVon||[]).includes('Lola');
      const lukiH = (r.geherztVon||[]).includes('Luki');
      let h=`<div class="recipe-card"><div class="recipe-header fav-header"><h2>${r.title}</h2><div class="recipe-hearts"><button class="heart-btn-mini ${loliH?'active':''}" onclick="toggleHeart('${r.id}','Lola',this)" title="Loli herzt">üç≠</button><button class="heart-btn-mini ${lukiH?'active':''}" onclick="toggleHeart('${r.id}','Luki',this)" title="Luki herzt">ü¶ñ</button></div>${r.subtitle?`<div class="subtitle">${r.subtitle}</div>`:''}<div class="recipe-meta">${r.prepTime?`<span>‚è± ${r.prepTime} Min</span>`:''}${r.servings?`<span>üçΩ ${r.servings} Portionen</span>`:''}<span>${r.source==='KI-generiert'?'‚ú® KI':'üìö Rezept'}</span></div></div>`;
      if(tags)h+=`<div class="recipe-tags">${tags}</div>`;
      if(r.tipps&&r.tipps.includes('üßÄ')&&both)h+=`<div class="compat-note">${r.tipps}</div>`;
      if(hasZutaten){h+=`<div class="recipe-section"><div class="recipe-section-title">Zutaten</div><div class="fav-zutaten">${r.zutaten.replace(/\n/g,'<br>')}</div></div>`}
      if(hasZubereitung){h+=`<div class="recipe-section"><div class="recipe-section-title">Zubereitung</div><div class="fav-zubereitung">${r.zubereitung.replace(/\n/g,'<br>')}</div></div>`}
      if(!hasZutaten&&!hasZubereitung&&r.link){
        h+=`<div class="recipe-section" id="favFetchSection"><div class="loading"><span class="loading-spoon">ü•Ñ</span><p>Lade Rezeptdetails<span class="loading-dots"></span></p></div></div>`;
      } else if(!hasZutaten&&!hasZubereitung){
        h+=`<div class="recipe-section" style="text-align:center;padding:1.5rem"><p style="color:var(--stone);font-size:0.85rem">Keine Details vorhanden</p></div>`;
      }
      if(r.tipps&&!r.tipps.includes('üßÄ'))h+=`<div class="recipe-tip"><strong>üí° Tipp:</strong> ${r.tipps}</div>`;
      if(r.link)h+=`<a class="link-btn" href="${r.link}" target="_blank" onclick="event.stopPropagation()">üìñ Originalrezept √∂ffnen</a>`;
      h+=`</div><button class="add-plan-btn" onclick="showDayPicker()">üìÖ Zum Wochenplan hinzuf√ºgen</button><button class="new-recipe-btn fav" onclick="showRandomFavorite()">üîÑ Anderes Rezept</button><button class="back-btn" onclick="showAllFavorites()">üìã Alle Rezepte anzeigen</button>`;
      result.innerHTML=h;result.scrollIntoView({behavior:'smooth',block:'start'});

      // Auto-fetch details from link if missing
      if(!hasZutaten&&!hasZubereitung&&r.link){
        fetchRecipeDetails(r);
      }
    }

    async function fetchRecipeDetails(r){
      const section=document.getElementById('favFetchSection');
      if(!section)return;
      try{
        const res=await fetch('/api/import-recipe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url:r.link,fetchOnly:true})});
        const data=await res.json();
        if(!res.ok||!data.success)throw new Error(data.error||'Fetch fehlgeschlagen');
        let h='';
        if(data.zutaten){h+=`<div class="recipe-section-title">Zutaten</div><div class="fav-zutaten">${data.zutaten.replace(/\n/g,'<br>')}</div>`}
        if(data.zubereitung){h+=`<div class="recipe-section-title">Zubereitung</div><div class="fav-zubereitung">${data.zubereitung.replace(/\n/g,'<br>')}</div>`}
        if(data.tipps){h+=`<div class="recipe-tip"><strong>üí° Tipp:</strong> ${data.tipps}</div>`}
        if(h){
          section.innerHTML=h;
          // Update Notion in background with fetched details
          fetch('/api/update-recipe-details',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({recipeId:r.id,zutaten:data.zutaten||'',zubereitung:data.zubereitung||'',tipps:data.tipps||''})}).catch(()=>{});
          // Update local cache
          const cached=notionFavorites.find(f=>f.id===r.id);
          if(cached){cached.zutaten=data.zutaten||'';cached.zubereitung=data.zubereitung||'';cached.tipps=data.tipps||'';localStorage.setItem('schipfie-notion-cache',JSON.stringify(notionFavorites))}
        } else {
          section.innerHTML='<p style="color:var(--stone);font-size:0.85rem;text-align:center">Keine Details gefunden</p>';
        }
      }catch(e){
        section.innerHTML=`<p style="color:var(--stone);font-size:0.85rem;text-align:center">Details konnten nicht geladen werden</p>`;
      }
    }

    async function saveToNotion(btn){
      if(btn.classList.contains('saved')||btn.classList.contains('saving'))return;btn.classList.add('saving');btn.textContent='‚è≥';
      const recipe=state.currentRecipe;if(!recipe){showToast('‚ùå Kein Rezept zum Speichern');btn.classList.remove('saving');btn.textContent='ü§ç';return}
      // Save locally first
      addSavedFav(recipe);
      try{const res=await fetch('/api/save-to-notion',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(recipe)});if(!res.ok)throw new Error((await res.json().catch(()=>({}))).error||'Fehler');btn.classList.remove('saving');btn.classList.add('saved','pop');btn.textContent='‚ù§Ô∏è';btn.style.pointerEvents='none';showToast('‚úÖ Gespeichert!')}
      catch(e){btn.classList.remove('saving');btn.classList.add('saved','pop');btn.textContent='‚ù§Ô∏è';btn.style.pointerEvents='none';showToast('‚ù§Ô∏è Lokal gespeichert (Notion-Sync fehlgeschlagen)')}
    }
    async function importRecipeFromUrl() {
      const input = document.getElementById('importUrlInput');
      const btn = document.getElementById('importBtn');
      const status = document.getElementById('importStatus');
      const url = input.value.trim();

      if (!url) { status.textContent = '‚ùå Bitte eine URL eingeben'; return; }
      if (!url.startsWith('http')) { status.textContent = '‚ùå Bitte eine g√ºltige URL eingeben'; return; }

      btn.disabled = true;
      btn.classList.add('loading');
      btn.textContent = '‚è≥';
      status.textContent = 'ü•Ñ Rezept wird analysiert‚Ä¶';

      try {
        const res = await fetch('/api/import-recipe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, passtFuer: ['Beide'] })
        });

        const data = await res.json();

        if (!res.ok || !data.success) {
          throw new Error(data.error || 'Import fehlgeschlagen');
        }

        status.innerHTML = `‚úÖ <strong>${data.title}</strong> gespeichert!`;
        input.value = '';

        // Reload favorites from Notion
        await loadFavoritesFromNotion();
        renderSavedFavorites();
        showToast(`‚úÖ ${data.title} importiert!`);

      } catch (e) {
        status.textContent = `‚ùå ${e.message}`;
      } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = '+';
      }
    }
    async function toggleHeart(recipeId, person, btn) {
      const isActive = btn.classList.contains('active');
      const action = isActive ? 'unheart' : 'heart';
      btn.classList.toggle('active');
      // Optimistic update in local cache
      const recipe = notionFavorites.find(r => r.id === recipeId);
      if(recipe) {
        if(action === 'heart') {
          if(!recipe.geherztVon.includes(person)) recipe.geherztVon.push(person);
        } else {
          recipe.geherztVon = recipe.geherztVon.filter(n => n !== person);
        }
        localStorage.setItem('schipfie-notion-cache', JSON.stringify(notionFavorites));
      }
      // Sync to Notion
      try {
        await fetch('/api/heart-recipe', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ recipeId, person, action })
        });
      } catch(e) {
        console.warn('Heart sync failed:', e);
        showToast('‚ö†Ô∏è Offline ‚Äî wird beim n√§chsten Mal synchronisiert');
      }
    }
    function showToast(msg){const t=document.getElementById('saveToast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}

    async function generateRecipe(){
      aiRecipeSavedId = null;
      const btn=document.getElementById('generateBtn');const result=document.getElementById('result');
      btn.disabled=true;btn.textContent='Wird gekocht‚Ä¶';
      result.innerHTML=`<div class="loading"><span class="loading-spoon">ü•Ñ</span><p>Claude kocht etwas Feines<span class="loading-dots"></span></p></div>`;
      try{const mealType=Array.from(state.mealTypes)[0]||'hauptgericht';const res=await fetch('/api/generate-recipe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({profiles:Array.from(state.profiles),filters:state.filters,cuisine:state.cuisine,mealType:mealType,maxMinutes:30,ingredient:state.ingredient||null})});if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(e.details||e.error||`HTTP ${res.status}`)}const recipe=await res.json();recipe.source='KI-generiert';recipe.profiles=Array.from(state.profiles);recipe.cuisine=state.cuisine;recipe.mealType=mealType;state.currentRecipe=recipe;renderAIRecipe(recipe)}
      catch(error){result.innerHTML=`<div class="error-card"><div class="emoji">üò¢</div><p>Da ist leider etwas schiefgegangen.</p><div class="error-detail">${error.message}</div><button class="new-recipe-btn" onclick="generateRecipe()">Nochmal versuchen</button></div>`}
      finally{btn.disabled=false;btn.textContent='Was kochen wir heute?'}
    }

    function renderAIRecipe(r){
      const result=document.getElementById('result');
      const tags=(r.tags||[]).map(t=>`<span class="recipe-tag">${t}</span>`).join('');
      const ingr=(r.ingredients||[]).map(i=>`<li><span class="ingredient-amount">${i.amount} ${i.unit||''}</span><span>${i.name}</span></li>`).join('');
      const steps=(r.steps||[]).map(s=>`<li>${s}</li>`).join('');
      result.innerHTML=`
        <div class="recipe-card"><div class="recipe-header"><h2>${r.title||'Rezept'}</h2><div class="recipe-hearts"><button class="heart-btn-mini" id="aiHeartLoli" onclick="saveAIAndHeart('Lola',this)" title="Loli herzt">üç≠</button><button class="heart-btn-mini" id="aiHeartLuki" onclick="saveAIAndHeart('Luki',this)" title="Luki herzt">ü¶ñ</button></div>${r.subtitle?`<div class="subtitle">${r.subtitle}</div>`:''}<div class="recipe-meta"><span>‚è± ${r.prepTime||'30'} Min</span><span>üçΩ ${r.servings||'2'} Portionen</span><span>‚ú® KI</span></div></div>
          ${tags?`<div class="recipe-tags">${tags}</div>`:''}
          ${r.nutrition?`<div class="recipe-nutrition"><div class="nutrition-item"><div class="nutrition-value">${r.nutrition.calories||'‚Äì'}</div><div class="nutrition-label">kcal</div></div><div class="nutrition-item"><div class="nutrition-value">${r.nutrition.protein||'‚Äì'}</div><div class="nutrition-label">Eiwei√ü</div></div><div class="nutrition-item"><div class="nutrition-value">${r.nutrition.fiber||'‚Äì'}</div><div class="nutrition-label">Ballaststoffe</div></div></div>`:''}
          <div class="recipe-section"><div class="recipe-section-title">Zutaten</div><ul class="ingredient-list">${ingr}</ul></div>
          <div class="recipe-section"><div class="recipe-section-title">Zubereitung</div><ol class="steps-list">${steps}</ol></div>
          ${r.tips?`<div class="recipe-tip"><strong>üí° Tipp:</strong> ${r.tips}</div>`:''}
          ${r.healthNote?`<div class="health-note"><strong>üåø Gesundheitshinweis:</strong> ${r.healthNote}</div>`:''}
        </div>
        <button class="add-plan-btn" onclick="showDayPicker()">üìÖ Zum Wochenplan hinzuf√ºgen</button>
        <button class="new-recipe-btn" onclick="generateRecipe()">üîÑ Neues Rezept</button>`;
      result.scrollIntoView({behavior:'smooth',block:'start'});
    }

    let aiRecipeSavedId = null; // Track if AI recipe was already saved to Notion

    async function saveAIAndHeart(person, btn){
      if(btn.classList.contains('saving'))return;
      const isActive = btn.classList.contains('active');
      const recipe=state.currentRecipe;
      if(!recipe){showToast('‚ùå Kein Rezept');return}

      btn.classList.add('saving');

      try{
        // First save: save to Notion if not yet saved
        if(!aiRecipeSavedId){
          recipe.geherztVon = [person];
          const res=await fetch('/api/save-to-notion',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(recipe)});
          if(!res.ok)throw new Error((await res.json().catch(()=>({}))).error||'Fehler');
          const data=await res.json();
          aiRecipeSavedId=data.id;
        }

        // Toggle heart
        const action = isActive ? 'unheart' : 'heart';
        await fetch('/api/heart-recipe',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({recipeId:aiRecipeSavedId,person,action})});
        btn.classList.toggle('active');
        btn.classList.remove('saving');
        showToast(action==='heart'?`${person==='Lola'?'üç≠':'ü¶ñ'} ${person} herzt das!`:`${person} hat Herz entfernt`);
        await loadFavoritesFromNotion();
      }catch(e){
        btn.classList.remove('saving');
        showToast('‚ùå '+e.message);
      }
    }

    // Init
    // Load cached favorites immediately for fast UI
    try { notionFavorites = JSON.parse(localStorage.getItem('schipfie-notion-cache')) || []; } catch(e) {}
    updateFavBadge();
    // Then refresh from Notion in background
    loadFavoritesFromNotion().then(() => {
      updateFavBadge();
      if(document.getElementById('screenFavorites').classList.contains('active')) renderSavedFavorites();
    });
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/sw.js').then(reg=>{
        // Check for updates on every app start
        reg.update();
        // Also check every 5 minutes while app is open
        setInterval(()=>reg.update(), 5*60*1000);
        // When a new SW is found, activate it and reload
        reg.addEventListener('updatefound',()=>{
          const newSW=reg.installing;
          if(!newSW)return;
          newSW.addEventListener('statechange',()=>{
            if(newSW.state==='installed' && navigator.serviceWorker.controller){
              newSW.postMessage('skipWaiting');
            }
          });
        });
      });
      // Reload when the new SW takes over
      let refreshing=false;
      navigator.serviceWorker.addEventListener('controllerchange',()=>{
        if(!refreshing){refreshing=true;window.location.reload()}
      });
    }
  </script>
</body>
</html>
